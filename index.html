<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pattern Breaker | LunaSoul</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÉ</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8A9A5B">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        window.onerror = function(msg, url, line) {
            // Only alert if it's not a minor resizing error
            if (msg.indexOf('ResizeObserver') === -1) {
                alert("System Error: " + msg);
            }
            return true;
        };
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { sage: { 50: '#f4f7f4', 100: '#E8EDE6', 500: '#8A9A5B', 600: '#738249', 700: '#5F6F46', 900: '#2f3823' }, sand: '#F5F5F0' } } }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F5F5F0; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #toast { visibility: hidden; min-width: 250px; transform: translateX(-50%); background-color: #2f3823; color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 100; left: 50%; bottom: 30px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #fff; border: 2px solid currentColor; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #E8EDE6; border-radius: 2px; }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col mx-auto max-w-md bg-sand transition-colors duration-300">

    <nav class="w-full bg-sage-500 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-2 cursor-pointer" onclick="navigateTo('screen-home')">
            <h1 class="font-semibold text-lg tracking-wide">Pattern Breaker</h1>
        </div>
        <div class="flex gap-3">
             <button id="upgradeBtn" onclick="showPaywall()" class="bg-white text-sage-700 px-3 py-1 rounded text-xs font-bold shadow hidden">Upgrade</button>
             <button onclick="navigateTo('screen-settings')" class="hover:text-sage-200"><i class="fas fa-cog"></i></button>
        </div>
    </nav>

    <div id="progress-container" class="w-full h-1.5 bg-gray-200 hidden">
        <div id="progress-fill" class="h-1.5 bg-sage-500 w-0 transition-all duration-500"></div>
    </div>

    <main id="app-container" class="flex-grow p-4 pb-24 relative overflow-y-auto">

        <div id="screen-home" class="fade-in">
            <div class="text-center mt-8 mb-8">
                <div class="w-24 h-24 bg-sage-100 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-inner">üçÉ</div>
                <h2 class="text-3xl font-bold text-sage-700">Welcome Home.</h2>
                <p class="text-gray-600 mt-4 text-sm leading-relaxed px-4">
                    Decode your pattern, interrupt the spiral, and return to safety in 60 seconds.
                </p>
            </div>
            
            <button onclick="navigateTo('screen-checkin')" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-105 mb-4">
                Start Check-In
            </button>

            <a href="https://angel-s-site-4148.thinkific.com/courses/understanding-relationship-patterns" target="_blank" class="block w-full bg-white border border-sage-200 text-sage-700 font-bold py-3 rounded-xl shadow-sm text-center text-sm mb-6 hover:bg-sage-50 transition">
                Take the Full Course
            </a>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="navigateTo('screen-vault')" class="bg-white p-3 rounded-lg shadow text-sm font-semibold text-gray-700"><i class="fas fa-book mr-2"></i>Vault</button>
                <button onclick="navigateTo('screen-rewrite')" class="bg-white p-3 rounded-lg shadow text-sm font-semibold text-gray-700"><i class="fas fa-pen-fancy mr-2"></i>Rewrite</button>
            </div>
            
            <p class="text-center text-xs text-gray-300 mt-8">v13.0</p>
        </div>

        <div id="screen-checkin" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-6">Check-In</h2>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">What's happening? (Vent here)</label>
                <textarea id="in-vent" oninput="state_vent = this.value" rows="3" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-base outline-none shadow-sm" placeholder="I'm spiraling because..."></textarea>
            </div>

            <div class="mb-8">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs font-bold text-gray-400 uppercase">Intensity</label>
                    <span id="intensity-val" class="font-bold text-sage-600 text-lg">5</span>
                </div>
                <div class="bg-white p-4 rounded-xl border border-sage-200">
                    <input type="range" id="in-intensity" min="1" max="10" value="5" oninput="updateSlider(this)">
                    <div class="flex justify-between text-xs text-gray-400 mt-2"><span>Low</span><span>Severe</span></div>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">My First Reaction is...</label>
                <select id="in-behavior" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-sm outline-none shadow-sm">
                    <option value="" disabled selected>Select behavior...</option>
                    <option value="hyper_independence">Pulling away / Isolating</option>
                    <option value="panic_clinging">Clinging / Panic texting</option>
                    <option value="shutdown">Emotional shutdown / Numbness</option>
                    <option value="over_giving">Over giving (to avoid rejection)</option>
                    <option value="over_explaining">Over explaining (to feel safe)</option>
                    <option value="distrust">Checking / Scanning for danger</option>
                    <option value="self_blame">Self-blame / "I'm too much"</option>
                </select>
            </div>

            <button onclick="runDecoder()" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-4 rounded-xl shadow-lg mt-4 flex justify-center items-center gap-2">
                <span id="decode-btn-text">Decode My Pattern</span>
                <i id="decode-spinner" class="fas fa-spinner fa-spin hidden"></i>
            </button>
        </div>

        <div id="screen-decode" class="hidden fade-in pb-10">
            <div class="bg-sage-100 p-6 rounded-xl mb-6 border-l-4 border-sage-500 shadow-sm relative">
                <p class="text-xs uppercase tracking-widest text-gray-500 mb-1">Detected Pattern</p>
                <h2 id="out-pattern" class="text-2xl font-bold text-sage-800 mb-2">...</h2>
                <div class="flex items-center gap-2">
                    <span id="out-badge" class="bg-sage-200 text-sage-800 text-xs px-2 py-1 rounded font-bold">Intensity: 5</span>
                </div>
            </div>

            <div class="bg-sage-600 p-5 rounded-xl shadow-lg mb-6 text-white text-center">
                <h3 class="font-bold text-lg mb-1">Go Deeper</h3>
                <p class="text-sm opacity-90 mb-3">You've identified the pattern. Now learn how to heal the root cause permanently.</p>
                <a href="https://angel-s-site-4148.thinkific.com/courses/understanding-relationship-patterns" target="_blank" class="inline-block bg-white text-sage-700 font-bold px-6 py-2 rounded-lg text-sm hover:bg-gray-100 transition">
                    View Course Modules
                </a>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm mb-6">
                <h3 class="font-bold text-gray-800 text-sm mb-2 uppercase border-b pb-2">What's Happening</h3>
                <p id="out-what" class="text-sm text-gray-600 leading-relaxed mb-4">...</p>
                <h3 class="font-bold text-gray-800 text-sm mb-2 uppercase border-b pb-2">Why It Activates</h3>
                <p id="out-why" class="text-sm text-gray-600 leading-relaxed">...</p>
            </div>

            <div class="grid grid-cols-1 gap-4 mb-6">
                <button onclick="showModule('Pattern Interrupter')" class="flex items-center justify-between p-4 bg-sage-500 text-white rounded-xl shadow-lg hover:bg-sage-600 transition">
                    <span class="font-bold"><i class="fas fa-bolt mr-2"></i>Pattern Interrupter</span><i class="fas fa-chevron-right"></i>
                </button>
                <button onclick="showModule('Daily Practice')" class="flex items-center justify-between p-4 bg-white border border-sage-200 text-gray-700 rounded-xl shadow-sm hover:bg-sage-50 transition">
                    <span class="font-bold"><i class="fas fa-leaf mr-2 text-sage-500"></i>Daily Practice</span><i class="fas fa-chevron-right text-gray-400"></i>
                </button>
                <button onclick="showModule('Anchor for Today')" class="flex items-center justify-between p-4 bg-white border border-sage-200 text-gray-700 rounded-xl shadow-sm hover:bg-sage-50 transition">
                    <span class="font-bold"><i class="fas fa-anchor mr-2 text-sage-500"></i>Anchor for Today</span><i class="fas fa-chevron-right text-gray-400"></i>
                </button>
                <button onclick="showModule('Journal Prompt')" class="flex items-center justify-between p-4 bg-white border border-sage-200 text-gray-700 rounded-xl shadow-sm hover:bg-sage-50 transition">
                    <span class="font-bold"><i class="fas fa-pen mr-2 text-sage-500"></i>Journal Prompt</span><i class="fas fa-chevron-right text-gray-400"></i>
                </button>
            </div>
            
            <button onclick="saveResultToVault()" class="w-full text-center text-sage-600 text-sm font-bold mb-4">Save Result to Vault</button>
            <button onclick="resetFlow()" class="w-full text-center text-gray-400 text-sm">Start Next Decode</button>
        </div>

        <div id="screen-module" class="hidden fade-in pt-6">
            <h2 id="mod-title" class="text-xl font-bold text-sage-700 mb-4">Module Title</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-sage-500 mb-6">
                <p id="mod-content" class="text-lg font-medium text-gray-800 leading-relaxed">Content...</p>
            </div>
            
            <div id="journal-area" class="hidden mb-4">
                <textarea id="journal-input-module" rows="10" class="w-full p-4 bg-white border border-sage-200 rounded-lg text-base focus:ring-2 focus:ring-sage-500 outline-none shadow-inner" placeholder="Reflect here..."></textarea>
            </div>

            <button onclick="saveModuleToVault()" class="w-full bg-sage-500 text-white font-bold py-3 rounded-xl shadow-lg mb-3">Save to Vault</button>
            <button onclick="navigateTo('screen-decode')" class="w-full text-gray-400 text-sm text-center">Back to Result</button>
        </div>

        <div id="screen-rewrite" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-4">Regulation Rewrite</h2>
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                <p class="text-xs text-gray-500 mb-2">Paste the anxious/angry text you *want* to send. We will rewrite it from a regulated state.</p>
                <textarea id="rewrite-input" rows="4" class="w-full p-3 border border-gray-200 rounded-lg text-sm bg-gray-50" placeholder="e.g. Why are you ignoring me?? I need an answer now."></textarea>
            </div>
            <button onclick="runRewrite()" class="w-full bg-sage-500 text-white font-bold py-3 rounded-xl shadow-lg mb-6">Rewrite It</button>
            
            <div id="rewrite-output" class="hidden">
                <h3 class="text-sm font-bold text-sage-700 mb-2">Try this instead:</h3>
                <div class="bg-sage-50 p-4 rounded-xl border border-sage-200 mb-4">
                    <p id="rewrite-result" class="text-sage-900 font-medium">...</p>
                </div>
                <button onclick="copyToClipboard('rewrite-result')" class="text-xs text-gray-400 underline w-full text-center">Copy to Clipboard</button>
            </div>
            
            <button onclick="navigateTo('screen-home')" class="w-full text-center text-gray-400 text-sm mt-6">Back Home</button>
        </div>

        <div id="screen-vault" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-sage-700">The Vault</h2>
                <button onclick="navigateTo('screen-home')" class="text-sm text-gray-400">Back</button>
            </div>
            
            <div class="relative mb-4">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                <input type="text" id="vault-search" onkeyup="renderVault()" placeholder="Search entries..." class="w-full pl-10 p-2 bg-white border border-gray-200 rounded-lg text-sm">
            </div>

            <div id="vault-list" class="space-y-4 pb-20"></div>
        </div>

        <div id="screen-settings" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-6">Settings</h2>
            <div class="bg-white rounded-xl shadow divide-y divide-gray-100">
                <div class="p-4 flex justify-between items-center">
                    <span>Dark Mode</span>
                    <button onclick="toggleDark()" class="text-sage-500 font-bold text-xs">Toggle</button>
                </div>
                <div class="p-4 flex justify-between items-center">
                    <span class="text-red-400">Clear Data</span>
                    <button onclick="clearVault()" class="text-red-500 font-bold text-xs">Clear</button>
                </div>
            </div>
            
            <div class="mt-8 text-center border-t pt-6">
                 <p class="text-xs text-gray-400 mb-2">Version 13.0</p>
                 <a href="https://angel-s-site-4148.thinkific.com/courses/understanding-relationship-patterns" target="_blank" class="text-sage-600 font-bold text-sm">Visit Course Page</a>
            </div>
            
            <button onclick="navigateTo('screen-home')" class="w-full text-center text-gray-400 text-sm mt-6">Back</button>
        </div>

    </main>

    <div id="toast">Action Saved</div>

    <div id="paywallModal" class="fixed inset-0 bg-black bg-opacity-60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Unlock the Vault</h2>
            <p class="text-gray-600 mb-6 text-sm">Save your entries and access journaling. Included for course students.</p>
            <a href="https://buy.stripe.com/4gM5kDfQX6uj2Ghb829fW00" target="_blank" class="block w-full bg-sage-500 text-white font-bold py-3 rounded-lg mb-4 hover:bg-sage-600">Subscribe for $5/mo</a>
            <div class="flex gap-2">
                <input type="text" id="accessCode" placeholder="STUDENT CODE" class="flex-grow border border-gray-300 rounded p-2 text-sm uppercase">
                <button onclick="checkCode()" class="bg-gray-800 text-white px-4 rounded text-sm">Unlock</button>
            </div>
            <button onclick="closePaywall()" class="mt-4 text-xs text-gray-400 underline">Close</button>
        </div>
    </div>

    <script>
        // --- 1. STATE ---
        let state_premium = localStorage.getItem('lunaPremium') === 'true';
        let state_vent = "";
        let state_intensity = 5;
        let state_result = null;
        let state_module = null;

        // --- 2. DECODER ENGINE (Deep Wisdom) ---
        const LOGIC_DB = {
            'hyper_independence': { 
                name: "Hyper Independence", 
                subtype: "Protection Mode", 
                what: "You are pushing others away to maintain control. Your system registers 'needing' as 'unsafe'. You are fortifying your walls because vulnerability feels like a threat.", 
                why: "This isn't about strength; it's a survival strategy. Early on, you likely learned that no one was coming to save you, so you decided to become your own savior. Your nervous system imprinted 'aloneness' as the only safety.", 
                interrupt: ["Drop your shoulders. Unclench your jaw.", "Say out loud: 'It is safe to let people in, just a little.'", "Lean back into your chair and let it support you."], 
                practice: "The 5% Rule: Ask for help with one tiny thing today. It can be as simple as asking someone to pass the salt. Notice that you survived the request.", 
                anchor: "I do not have to carry it all to be safe.", 
                prompt: "What story am I telling myself about what will happen if I admit I need support right now?" 
            },
            'panic_clinging': { 
                name: "Anxious Grasping", 
                subtype: "Fight Mode Activation", 
                what: "Your nervous system is screaming. You feel an urgent, frantic need to 'fix' the connection immediately. This is not love; this is a fight response to the threat of abandonment.", 
                why: "This is an attachment wound being touched. Your child-self learned that 'distance' meant 'danger'. Your body is mobilizing energy to bridge the gap because it feels life-threatening.", 
                interrupt: ["Put the phone down. Walk into another room immediately.", "Push your hands hard against a wall for 10 seconds to discharge the adrenaline.", "Splash cold water on your face to reset your vagus nerve."], 
                practice: "Self-Soothing: Place a hand on your chest and say 'I am here with you. I am not leaving you.' Repeat until your breathing slows.", 
                anchor: "My safety is inside me, not in their response.", 
                prompt: "What am I trying to earn from them right now that I can give to myself?" 
            },
            'shutdown': { 
                name: "Emotional Shutdown", 
                subtype: "Freeze/Collapse Mode", 
                what: "You are going numb. You feel foggy, distant, or 'checked out'. This is your system pulling the emergency brake to protect you from overwhelming pain.", 
                why: "This is a learned survival strategy. When things got too heavy or scary in the past, your only option was to disappear inside yourself. You are not broken; you are protecting your core.", 
                interrupt: ["Shake your hands vigorously for 30 seconds.", "Wrap yourself tightly in a heavy blanket (burrito wrap).", "Stomp your feet on the ground 10 times."], 
                practice: "Orientation: Name 3 colors you see in the room out loud. Then name 3 textures you can feel. Bring your brain back to the present moment.", 
                anchor: "It is safe to be in my body. I am right here.", 
                prompt: "What specific emotion am I numbing out to avoid feeling right now?" 
            },
            'over_explaining': { 
                name: "Over-Explaining", 
                subtype: "Fawn/Appeasement Mode", 
                what: "You are over-talking and over-giving to manage the other person's emotions. You believe if you explain yourself perfectly, you won't be rejected.", 
                why: "You learned that your needs were 'too much' or unsafe. You survived by becoming easy, manageable, and 'good'. You are abandoning your truth to keep the peace.", 
                interrupt: ["Stop talking. Take a breath.", "Say: 'I've said enough.'", "Press your tongue to the roof of your mouth to stop the urge to speak."], 
                practice: "The Pause: Count to 5 before responding to anything today. Allow silence to exist without filling it.", 
                anchor: "I do not need to explain my existence to be worthy.", 
                prompt: "Where am I shrinking myself to make someone else comfortable?" 
            },
            'over_giving': { 
                name: "Over Giving", 
                subtype: "Fawn/Appeasement", 
                what: "You are pouring out energy and resources to ensure you are 'needed.' You are preemptively paying a debt you don't owe.", 
                why: "You learned that love was conditional on your utility. If you stop giving, you fear you will become disposable.", 
                interrupt: ["Clench your fists, then release.", "Ask yourself: 'Do I actually want to do this, or am I just afraid to say no?'"], 
                practice: "Say 'No' to one small thing today. It doesn't have to be big. Just reclaim one piece of your energy.", 
                anchor: "My value is not in what I provide. I am enough.", 
                prompt: "What am I trying to buy with my generosity?" 
            },
            'distrust': { 
                name: "Hyper-Vigilance", 
                subtype: "Scan Mode", 
                what: "You are waiting for the other shoe to drop. You are analyzing tone, timing, and words, looking for betrayal or rejection.", 
                why: "Chaos feels familiar to you; stability feels suspicious. Your nervous system is wired to scan for danger because you weren't protected in the past.", 
                interrupt: ["Look around the room. Find 3 cues of safety (a locked door, a cozy chair).", "Fact-check: What is real vs. what is my fear imagining?"], 
                practice: "Reality Testing: Write down the facts in one column and your 'story' in the other. See the difference.", 
                anchor: "I can trust myself to handle whatever happens.", 
                prompt: "What story am I inventing to prepare myself for pain?" 
            },
            'self_blame': { 
                name: "Internalized Blame", 
                subtype: "Shame Mode", 
                what: "You are taking 100% of the responsibility for the disconnection. You are turning the anger inward on yourself.", 
                why: "As a child, it was safer to believe 'I am bad' (which I can fix) than 'My caregiver is unsafe' (which is terrifying). You are blaming yourself to maintain a sense of control.", 
                interrupt: ["Say out loud: 'This is not all my fault.'", "Push your feet firmly into the floor.", "Release the tension in your stomach."], 
                practice: "Compassion: Talk to yourself like you would talk to your best friend who made a mistake.", 
                anchor: "I am not the problem. I am worthy of repair.", 
                prompt: "What responsibility am I carrying that actually belongs to someone else?" 
            }
        };

        // --- 2. GLOBAL FUNCTIONS ---
        function navigateTo(id) {
            document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            
            const bar = document.getElementById('progress-container');
            const fill = document.getElementById('progress-fill');
            const progress = { 'screen-home': '0%', 'screen-checkin': '33%', 'screen-decode': '66%', 'screen-regulate': '100%' }[id];
            
            if (progress && progress !== '0%') {
                bar.classList.remove('hidden');
                setTimeout(() => fill.style.width = progress, 50);
            } else { bar.classList.add('hidden'); }

            if(id === 'screen-vault') renderVault();
        }

        function runDecoder() {
            try {
                const b = document.getElementById('in-behavior').value;
                if(!b) return alert("Please select a behavior.");
                
                state_vent = document.getElementById('in-vent').value;
                state_intensity = document.getElementById('in-intensity').value;

                // Loading UI
                document.getElementById('decode-btn-text').innerText = "Analyzing...";
                document.getElementById('decode-spinner').classList.remove('hidden');

                setTimeout(() => {
                    const data = LOGIC_DB[b] || LOGIC_DB['panic_clinging'];
                    
                    state_result = {
                        pattern: data.name,
                        subtype: `${data.subtype} ‚Ä¢ Intensity: ${state_intensity}`,
                        what: data.what,
                        why: data.why,
                        interrupt: data.interrupt,
                        practice: data.practice,
                        anchor: data.anchor,
                        prompt: data.prompt,
                        date: new Date()
                    };

                    // Safe UI Updates
                    if(document.getElementById('out-pattern')) document.getElementById('out-pattern').innerText = state_result.pattern;
                    if(document.getElementById('out-subtype')) document.getElementById('out-subtype').innerText = state_result.subtype;
                    if(document.getElementById('out-badge')) document.getElementById('out-badge').innerText = "Intensity: " + state_intensity;
                    if(document.getElementById('out-what')) document.getElementById('out-what').innerText = state_result.what;
                    if(document.getElementById('out-why')) document.getElementById('out-why').innerText = state_result.why;

                    // Navigate
                    document.getElementById('decode-btn-text').innerText = "Decode My Pattern";
                    document.getElementById('decode-spinner').classList.add('hidden');
                    navigateTo('screen-decode');

                }, 800);

            } catch (e) {
                alert("Analysis Error: " + e.message);
            }
        }

        function showModule(type) {
            if (type === 'Journal Prompt' && !state_premium) return showPaywall();
            
            state_module = type;
            document.getElementById('mod-title').innerText = type;
            
            const r = state_result;
            let content = "";
            
            if (type === "Pattern Interrupter") content = Array.isArray(r.interrupt) ? r.interrupt[Math.floor(Math.random() * r.interrupt.length)] : r.interrupt;
            else if (type === "Daily Practice") content = r.practice;
            else if (type === "Anchor for Today") content = `"${r.anchor}"`;
            else if (type === "Journal Prompt") content = r.prompt;

            document.getElementById('mod-content').innerText = content;

            const jArea = document.getElementById('journal-area');
            if (type === 'Journal Prompt') {
                jArea.classList.remove('hidden');
                document.getElementById('journal-input-module').value = state_vent ? `[Initial Vent]: ${state_vent}\n\n` : "";
            } else { jArea.classList.add('hidden'); }

            navigateTo('screen-module');
        }

        function regenerate(type) {
            const r = state_result;
            // Only regeneration for Interrupter in this version to keep logic simple
            if (type === 'interrupt' && Array.isArray(r.interrupt)) {
                const next = r.interrupt[Math.floor(Math.random() * r.interrupt.length)];
                document.getElementById('mod-interrupt-text').innerText = next;
                showToast("Refreshed");
            }
        }

        function runRewrite() {
            const text = document.getElementById('rewrite-input').value;
            if(!text) return;
            document.getElementById('rewrite-result').innerText = "I'm feeling overwhelmed right now and need to pause. Let's connect when I'm calm.";
            document.getElementById('rewrite-output').classList.remove('hidden');
        }

        function saveResultToVault() {
            if(!state_premium) return showPaywall();
            saveToVault("Pattern Result", state_result.pattern);
        }

        function saveModuleToVault() {
            if(!state_premium) return showPaywall();
            let content = document.getElementById('mod-content').innerText;
            if (state_module === 'Journal Prompt') {
                content += "\n\n" + document.getElementById('journal-input-module').value;
            }
            saveToVault(state_module, content);
        }

        function saveToVault(type, content) {
            const entry = { date: new Date(), type: type, content: content, pattern: state_result.pattern, intensity: state_intensity };
            const vault = JSON.parse(localStorage.getItem('lunaVault') || '[]');
            vault.unshift(entry);
            localStorage.setItem('lunaVault', JSON.stringify(vault));
            showToast("Saved to Vault");
        }

        function renderVault() {
            const term = document.getElementById('vault-search').value.toLowerCase();
            const vault = JSON.parse(localStorage.getItem('lunaVault') || '[]');
            const filtered = vault.filter(e => JSON.stringify(e).toLowerCase().includes(term));
            const list = document.getElementById('vault-list');
            
            if(filtered.length === 0) return list.innerHTML = '<p class="text-center text-gray-400 mt-10">Empty.</p>';
            list.innerHTML = filtered.map((e, i) => `
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-sage-500 mb-3 relative">
                    <div class="flex justify-between mb-2"><span class="font-bold text-gray-800">${e.pattern}</span><span class="text-xs text-gray-400">${new Date(e.date).toLocaleDateString()}</span></div>
                    <p class="text-xs font-bold text-sage-500 uppercase mb-1">${e.type} (Level ${e.intensity || 5})</p>
                    <p class="text-sm text-gray-800 whitespace-pre-wrap">${e.content}</p>
                    <button onclick="deleteEntry(${i})" class="absolute top-2 right-2 text-red-300"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        function deleteEntry(i) {
            if(!confirm("Delete?")) return;
            const vault = JSON.parse(localStorage.getItem('lunaVault') || '[]');
            vault.splice(i, 1);
            localStorage.setItem('lunaVault', JSON.stringify(vault));
            renderVault();
        }

        function clearVault() {
            if(confirm("Clear all data?")) { localStorage.removeItem('lunaVault'); location.reload(); }
        }

        function updateSlider(el) { document.getElementById('intensity-val').innerText = el.value; }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); }
        function toggleDark() { document.documentElement.classList.toggle('dark'); }
        function copyToClipboard(id) { navigator.clipboard.writeText(document.getElementById(id).innerText); showToast("Copied"); }
        function showPaywall() { document.getElementById('paywallModal').classList.remove('hidden'); }
        function closePaywall() { document.getElementById('paywallModal').classList.add('hidden'); }
        
        function checkCode() {
            if (document.getElementById('accessCode').value.toUpperCase() === 'LUNA2025') {
                state_premium = true; localStorage.setItem('lunaPremium', 'true');
                alert("Unlocked!"); closePaywall(); document.getElementById('upgradeBtn').classList.add('hidden');
            } else { alert("Incorrect Code"); }
        }

        function resetFlow() {
            state_vent = ""; state_intensity = 5;
            document.getElementById('in-vent').value = "";
            document.getElementById('in-behavior').value = "";
            navigateTo('screen-home');
        }

        // --- INIT ---
        if(state_premium) document.getElementById('upgradeBtn').classList.add('hidden');
        navigateTo('screen-home');

    </script>
</body>
</html>