<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pattern Breaker | LunaSoul</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÉ</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8A9A5B">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { sage: { 50: '#f4f7f4', 100: '#E8EDE6', 500: '#8A9A5B', 600: '#738249', 700: '#5F6F46', 900: '#2f3823' }, sand: '#F5F5F0' } } }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F5F5F0; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Toast Notification */
        #toast { visibility: hidden; min-width: 250px; transform: translateX(-50%); background-color: #2f3823; color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 100; left: 50%; bottom: 30px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        
        /* Range Slider */
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #fff; border: 2px solid currentColor; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #E8EDE6; border-radius: 2px; }

        /* Mic Pulse */
        .mic-active { color: #ef4444 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col mx-auto max-w-md bg-sand transition-colors duration-300 dark:bg-gray-900 dark:text-gray-100">

    <nav class="w-full bg-sage-500 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-2 cursor-pointer" onclick="App.navigateTo('screen-home')">
            <h1 class="font-semibold text-lg tracking-wide">Pattern Breaker</h1>
        </div>
        <div class="flex gap-3">
             <button id="upgradeBtn" onclick="UI.showPaywall()" class="bg-white text-sage-700 px-3 py-1 rounded text-xs font-bold shadow hidden">Upgrade</button>
             <button onclick="App.navigateTo('screen-settings')" class="hover:text-sage-200"><i class="fas fa-cog"></i></button>
        </div>
    </nav>

    <main id="app-container" class="flex-grow p-4 pb-24 relative overflow-y-auto">

        <div id="screen-home" class="fade-in">
            <div class="text-center mt-8 mb-8">
                <div class="w-24 h-24 bg-sage-100 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-inner">üçÉ</div>
                <h2 class="text-3xl font-bold text-sage-700 dark:text-sage-300">Welcome Home.</h2>
                <p class="text-gray-600 dark:text-gray-300 mt-4 text-sm leading-relaxed px-4">
                    Decode your abandonment patterns, interrupt the spiral, and return to safety.
                </p>
            </div>
            
            <button onclick="App.navigateTo('screen-safety')" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-105 mb-4">
                Start Check-In (Free)
            </button>

            <button onclick="App.startPremiumJournal()" class="w-full bg-white border-2 border-sage-500 text-sage-700 font-bold py-4 rounded-xl shadow-sm transition mb-4 flex justify-center items-center gap-2 dark:bg-gray-800 dark:border-sage-400 dark:text-sage-300">
                <i class="fas fa-pen-nib"></i> Guided Journaling <span id="lock-icon" class="text-xs ml-1">üîí</span>
            </button>

            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="App.navigateTo('screen-vault')" class="bg-white p-3 rounded-lg shadow text-sm font-semibold text-gray-700 dark:bg-gray-800 dark:text-gray-300"><i class="fas fa-book mr-2"></i>Vault</button>
                <button onclick="UI.toggleModal('modal-about')" class="bg-white p-3 rounded-lg shadow text-sm font-semibold text-gray-700 dark:bg-gray-800 dark:text-gray-300"><i class="fas fa-info-circle mr-2"></i>About</button>
            </div>
            
            <div class="mt-6 text-center">
                <a href="https://angel-s-site-4148.thinkific.com/courses/understanding-relationship-patterns" target="_blank" class="text-xs text-sage-600 font-bold underline dark:text-sage-400">Take the Full Course</a>
            </div>
        </div>

        <div id="screen-safety" class="hidden fade-in pt-6">
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-sage-500 dark:bg-gray-800">
                <h2 class="text-xl font-bold text-gray-800 mb-4 dark:text-white"><i class="fas fa-heart text-sage-500 mr-2"></i>Emotional Safety</h2>
                <p class="text-sm text-gray-600 leading-relaxed mb-4 dark:text-gray-300">
                    This is a self-guided tool. It is not a substitute for therapy. Some prompts may bring up strong emotions ‚Äî please pause if you need to.
                </p>
                <div class="bg-sage-50 p-3 rounded-lg mb-6 dark:bg-gray-700">
                    <h3 class="text-xs font-bold text-sage-700 uppercase mb-1 dark:text-sage-300"><i class="fas fa-lock mr-1"></i> Privacy Notice</h3>
                    <p class="text-xs text-gray-600 dark:text-gray-400">Your journal entries are stored <strong>only on this device</strong>. We do not see your data.</p>
                </div>
                <button onclick="App.navigateTo('screen-checkin')" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-3 rounded-lg">I Understand & Proceed</button>
                <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-4 dark:text-sage-400">Back</button>
            </div>
        </div>

        <div id="screen-checkin" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-6 dark:text-sage-300">Check-In</h2>
            <div class="mb-6 relative">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">What's happening? (Vent here)</label>
                <textarea id="in-vent" rows="3" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-base outline-none shadow-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white" placeholder="I'm spiraling because..."></textarea>
                <button onclick="App.startVoice('in-vent')" class="absolute bottom-3 right-3 text-gray-400 hover:text-sage-500"><i class="fas fa-microphone"></i></button>
            </div>
            <div class="mb-8">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Intensity (1-10)</label>
                <input type="range" id="in-intensity" min="1" max="10" value="5" class="w-full" oninput="document.getElementById('intensity-val').innerText = this.value">
                <p class="text-center font-bold text-sage-600 mt-2 dark:text-sage-400">Level: <span id="intensity-val">5</span></p>
            </div>
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">First Reaction?</label>
                <select id="in-behavior" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-sm outline-none shadow-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                    <option value="" disabled selected>Select behavior...</option>
                    <option value="hyper_independence">Pulling away / Isolating</option>
                    <option value="panic_clinging">Clinging / Panic texting</option>
                    <option value="shutdown">Emotional shutdown / Numbness</option>
                    <option value="over_giving">Over giving (Appeasement)</option>
                    <option value="over_explaining">Over explaining (Fawn)</option>
                    <option value="distrust">Checking / Scanning (Hypervigilance)</option>
                    <option value="self_blame">Self-blame (Shame)</option>
                </select>
            </div>
            <button onclick="Decoder.run()" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-4 rounded-xl shadow-lg mt-4" id="btn-decode">Decode My Pattern</button>
            <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-4 dark:text-sage-400">Back</button>
        </div>

        <div id="screen-result" class="hidden fade-in pb-10">
            <div class="bg-sage-100 p-6 rounded-xl mb-6 border-l-4 border-sage-500 shadow-sm dark:bg-gray-800 dark:border-sage-400">
                <p class="text-xs uppercase tracking-widest text-gray-500 mb-1 dark:text-gray-400">Detected Pattern</p>
                <h2 id="out-pattern" class="text-2xl font-bold text-sage-800 mb-2 dark:text-white">...</h2>
                <p id="out-subtype" class="text-sm font-semibold text-sage-600 dark:text-sage-300">...</p>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm mb-6 dark:bg-gray-800">
                <h3 class="font-bold text-gray-800 text-sm mb-2 border-b pb-2 dark:text-gray-200">What's Happening</h3>
                <p id="out-what" class="text-sm text-gray-600 leading-relaxed mb-4 dark:text-gray-300">...</p>
                <h3 class="font-bold text-gray-800 text-sm mb-2 border-b pb-2 dark:text-gray-200">Why It Activates</h3>
                <p id="out-why" class="text-sm text-gray-600 leading-relaxed dark:text-gray-300">...</p>
            </div>
            
            <div class="grid grid-cols-1 gap-3 mb-6">
                <button onclick="App.showModule('Pattern Interrupter')" class="p-4 bg-sage-500 text-white rounded-xl shadow font-bold text-left"><i class="fas fa-bolt mr-2"></i>Pattern Interrupter</button>
                <button onclick="App.showModule('Daily Practice')" class="p-4 bg-white border border-sage-200 rounded-xl shadow text-left dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200"><i class="fas fa-leaf mr-2 text-sage-500"></i>Daily Practice</button>
                <button onclick="App.showModule('Anchor for Today')" class="p-4 bg-white border border-sage-200 rounded-xl shadow text-left dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200"><i class="fas fa-anchor mr-2 text-sage-500"></i>Anchor</button>
            </div>

            <div class="bg-white border-2 border-sage-100 p-4 rounded-xl mb-4 text-center dark:bg-gray-800 dark:border-gray-600">
                <h3 class="font-bold text-sage-700 mb-2 dark:text-sage-300">Ready to heal the root?</h3>
                <p class="text-xs text-gray-500 mb-3 dark:text-gray-400">The app manages the symptom. The course heals the wound.</p>
                <a href="https://angel-s-site-4148.thinkific.com/courses/understanding-relationship-patterns" target="_blank" class="block bg-sage-100 text-sage-700 py-2 rounded-lg font-bold text-sm hover:bg-sage-200">View Course</a>
            </div>

            <button onclick="Vault.saveFreeEntry()" class="w-full text-center text-sage-600 text-sm font-bold mb-4 dark:text-sage-400">Save Result</button>
            <button onclick="App.reset()" class="w-full text-center text-gray-400 text-sm">Start Next Decode</button>
        </div>

        <div id="screen-module" class="hidden fade-in pt-6">
            <h2 id="mod-title" class="text-xl font-bold text-sage-700 mb-4 dark:text-sage-300">Module</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-sage-500 mb-6 dark:bg-gray-800">
                <p id="mod-content" class="text-lg font-medium text-gray-800 leading-relaxed dark:text-gray-200">...</p>
            </div>
            <button onclick="App.navigateTo('screen-result')" class="w-full text-sage-600 font-bold text-center dark:text-sage-400">Back</button>
        </div>

        <div id="screen-premium-journal" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-4 dark:text-sage-300">Guided Journaling</h2>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Select a Prompt</label>
                <select id="prem-prompt" class="w-full p-3 bg-white border border-sage-200 rounded-xl text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                    <option>What emotion felt biggest today?</option>
                    <option>Where did you downplay your needs?</option>
                    <option>What pattern repeated itself today?</option>
                    <option>What is the story I am telling myself?</option>
                </select>
            </div>
            <div class="relative">
                <textarea id="prem-text" rows="10" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-base focus:ring-2 focus:ring-sage-500 outline-none mb-4 dark:bg-gray-800 dark:border-gray-600 dark:text-white" placeholder="Reflect here..."></textarea>
                <button onclick="App.startVoice('prem-text')" class="absolute bottom-6 right-3 text-gray-400 hover:text-sage-500"><i class="fas fa-microphone"></i></button>
            </div>
            <button onclick="Vault.savePremiumEntry()" class="w-full bg-sage-500 text-white font-bold py-3 rounded-xl shadow-lg">Analyze & Save</button>
            <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-4 dark:text-sage-400">Cancel</button>
        </div>

        <div id="screen-vault" class="hidden fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-sage-700 dark:text-sage-300">The Vault</h2>
                <button onclick="App.navigateTo('screen-home')" class="text-sm text-sage-600 font-bold dark:text-sage-400">Back</button>
            </div>
            <div class="flex mb-4 bg-white rounded-lg p-1 shadow-sm dark:bg-gray-800">
                <button onclick="Vault.switchTab('free')" id="tab-free" class="flex-1 py-2 text-xs font-bold rounded bg-sage-100 text-sage-700">Check-Ins</button>
                <button onclick="Vault.switchTab('premium')" id="tab-premium" class="flex-1 py-2 text-xs font-bold rounded text-gray-400">Journal</button>
            </div>
            <div id="vault-content" class="space-y-3 pb-20"></div>
        </div>

        <div id="screen-settings" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-6 dark:text-sage-300">Settings</h2>
            <div class="bg-white rounded-xl shadow divide-y divide-gray-100 dark:bg-gray-800 dark:divide-gray-700">
                <div class="p-4 flex justify-between items-center">
                    <span>Dark Mode</span>
                    <button onclick="UI.toggleDark()" class="text-sage-500 font-bold text-xs">Toggle</button>
                </div>
                <div class="p-4 flex justify-between items-center">
                    <span class="text-red-400">Clear Data</span>
                    <button onclick="Vault.clear()" class="text-red-500 font-bold text-xs">Clear</button>
                </div>
            </div>
            <div class="mt-8 text-center border-t pt-6 dark:border-gray-700">
                 <p class="text-xs text-gray-400 mb-2">Version 16.0</p>
                 <a href="https://angel-s-site-4148.thinkific.com/courses/understanding-relationship-patterns" target="_blank" class="text-sage-600 font-bold text-sm dark:text-sage-400">Visit Course Page</a>
            </div>
            <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-6 dark:text-sage-400">Back</button>
        </div>

        <div id="modal-about" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl p-6 max-w-sm w-full relative dark:bg-gray-800">
                <h2 class="text-xl font-bold text-sage-700 mb-4 dark:text-sage-300">About Pattern Breaker</h2>
                <p class="text-sm text-gray-600 mb-4 dark:text-gray-300">This tool helps you identify emotional patterns connected to abandonment wounds and offers self-guided practices to interrupt them.</p>
                <button onclick="UI.toggleModal('modal-about')" class="w-full bg-sage-500 text-white py-2 rounded-lg font-bold">Close</button>
            </div>
        </div>

    </main>

    <div id="toast">Saved</div>

    <div id="paywallModal" class="fixed inset-0 bg-black bg-opacity-60 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center dark:bg-gray-800">
            <h2 class="text-2xl font-bold text-gray-800 mb-2 dark:text-white">Unlock the Vault</h2>
            <p class="text-gray-600 mb-6 text-sm dark:text-gray-300">Save your entries and access journaling. Included for course students.</p>
            <a href="https://buy.stripe.com/4gM5kDfQX6uj2Ghb829fW00" target="_blank" class="block w-full bg-sage-500 text-white font-bold py-3 rounded-lg mb-4 hover:bg-sage-600">Subscribe for $5/mo</a>
            <div class="flex gap-2">
                <input type="text" id="accessCode" placeholder="CODE" class="flex-grow border border-gray-300 rounded p-2 text-sm uppercase dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <button onclick="App.checkCode()" class="bg-gray-800 text-white px-4 rounded text-sm">Unlock</button>
            </div>
            <button onclick="UI.closePaywall()" class="mt-4 text-xs text-gray-400 underline">Close</button>
        </div>
    </div>

    <script>
        // --- 1. STATE ---
        const State = {
            premium: localStorage.getItem('lunaPremium') === 'true',
            vault: JSON.parse(localStorage.getItem('lunaVault') || '{"free":[],"premium":[],"reports":[]}'),
            currentResult: null
        };

        // --- 2. DATABASE ---
        const LOGIC_DB = {
            'hyper_independence': { name: "Hyper Independence", subtype: "Protection Mode", what: "You are pushing others away to maintain control. Your system registers 'needing' as 'unsafe'. You are fortifying your walls because vulnerability feels like a threat.", why: "This isn't about strength; it's a survival strategy. Early on, you likely learned that no one was coming to save you, so you decided to become your own savior.", interrupt: ["Drop your shoulders. Unclench your jaw.", "Say out loud: 'It is safe to let people in.'", "Lean back into your chair."], practice: "The 5% Rule: Ask for help with one tiny thing today.", anchor: "I do not have to carry it all to be safe.", prompt: "What am I afraid will happen if I admit I need support right now?" },
            'panic_clinging': { name: "Anxious Grasping", subtype: "Fight Mode Activation", what: "Your nervous system is screaming. You feel an urgent, frantic need to 'fix' the connection immediately. This is not love; this is a fight response.", why: "This is an attachment wound being touched. Your child-self learned that 'distance' meant 'danger'. Your body is mobilizing energy to bridge the gap.", interrupt: ["Put the phone down. Walk away.", "Push hands hard against a wall.", "Splash cold water on your face."], practice: "Self-Soothing: Place a hand on your chest and say 'I am here with you.'", anchor: "My safety is inside me, not in their response.", prompt: "What am I trying to earn from them that I can give to myself?" },
            'shutdown': { name: "Emotional Shutdown", subtype: "Freeze/Collapse Mode", what: "You are going numb. You feel foggy, distant, or 'checked out'. This is your system pulling the emergency brake to protect you from overwhelming pain.", why: "This is a learned survival strategy. When things got too heavy or scary in the past, your only option was to disappear inside yourself.", interrupt: ["Shake your hands vigorously.", "Wrap yourself in a blanket.", "Stomp your feet 10 times."], practice: "Orientation: Name 3 colors you see in the room out loud.", anchor: "It is safe to be in my body. I am right here.", prompt: "What specific emotion am I numbing out to avoid feeling right now?" },
            'over_explaining': { name: "Over-Explaining", subtype: "Fawn/Appeasement", what: "You are over-talking and over-giving to manage the other person's emotions. You believe if you explain yourself perfectly, you won't be rejected.", why: "You learned that your needs were 'too much'. You survived by becoming easy, manageable, and 'good'.", interrupt: ["Stop talking. Take a breath.", "Say: 'I've said enough.'", "Press tongue to roof of mouth."], practice: "The Pause: Count to 5 before responding today.", anchor: "I do not need to explain my existence to be worthy.", prompt: "Where am I shrinking myself to make someone else comfortable?" },
            'over_giving': { name: "Over Giving", subtype: "Fawn/Appeasement", what: "You are pouring out energy and resources to ensure you are 'needed.' You are preemptively paying a debt you don't owe.", why: "You learned that love was conditional on your utility. If you stop giving, you fear you will become disposable.", interrupt: ["Clench your fists, then release.", "Ask: 'Do I actually want to do this?'"], practice: "Say 'No' to one small thing today.", anchor: "My value is not in what I provide. I am enough.", prompt: "What am I trying to buy with my generosity?" },
            'distrust': { name: "Hyper-Vigilance", subtype: "Scan Mode", what: "You are waiting for the other shoe to drop. You are analyzing tone, timing, and words, looking for betrayal or rejection.", why: "Chaos feels familiar to you; stability feels suspicious. Your nervous system is wired to scan for danger.", interrupt: ["Look around. Find 3 cues of safety.", "Fact-check: What is real vs. imagined?"], practice: "Reality Testing: Write down facts vs. story.", anchor: "I can trust myself to handle whatever happens.", prompt: "What story am I inventing to prepare myself for pain?" },
            'self_blame': { name: "Internalized Blame", subtype: "Shame Mode", what: "You are taking 100% of the responsibility for the disconnection. You are turning the anger inward on yourself.", why: "As a child, it was safer to believe 'I am bad' (which I can fix) than 'My caregiver is unsafe' (which is terrifying).", interrupt: ["Say: 'This is not all my fault.'", "Push feet into floor."], practice: "Compassion: Talk to yourself like a friend.", anchor: "I am not the problem. I am worthy of repair.", prompt: "What responsibility am I carrying that isn't mine?" }
        };

        // --- 3. CONTROLLERS ---
        const Vault = {
            activeTab: 'free',
            save: function() { localStorage.setItem('lunaVault', JSON.stringify(State.vault)); },
            
            saveFreeEntry: function() {
                const b = document.getElementById('in-behavior').value;
                const v = document.getElementById('in-vent').value;
                const i = document.getElementById('in-intensity').value;
                
                const entry = { id: Date.now(), date: new Date().toISOString(), result: State.currentResult, inputs: { behavior: b, vent: v, intensity: i } };
                State.vault.free.unshift(entry);
                Vault.save();
                UI.toast("Saved to Vault");
            },

            savePremiumEntry: function() {
                const text = document.getElementById('prem-text').value;
                if (!text) return alert("Please write something.");
                
                const entry = { id: Date.now(), date: new Date().toISOString(), prompt: document.getElementById('prem-prompt').value, text: text };
                State.vault.premium.unshift(entry);
                Vault.save();
                UI.toast("Saved");
                App.navigateTo('screen-home');
            },

            switchTab: function(tab) {
                Vault.activeTab = tab;
                document.querySelectorAll('#screen-vault button[id^="tab-"]').forEach(b => {
                    b.classList.remove('bg-sage-100', 'text-sage-700');
                    b.classList.add('text-gray-400');
                });
                document.getElementById('tab-' + tab).classList.add('bg-sage-100', 'text-sage-700');
                document.getElementById('tab-' + tab).classList.remove('text-gray-400');
                Vault.render(tab);
            },

            render: function(tab = Vault.activeTab) {
                const list = document.getElementById('vault-content');
                const data = State.vault[tab];
                if (!data || data.length === 0) { list.innerHTML = '<p class="text-center text-gray-400 mt-10">No entries yet.</p>'; return; }

                list.innerHTML = data.map(e => {
                    const date = new Date(e.date).toLocaleDateString();
                    if (tab === 'free') {
                        return `<div class="bg-white p-4 rounded-xl shadow border-l-4 border-sage-500 relative mb-3 dark:bg-gray-800">
                            <div class="flex justify-between mb-1"><span class="font-bold text-gray-800 dark:text-white">${e.result.name}</span><span class="text-xs text-gray-400">${date}</span></div>
                            <div class="text-xs text-sage-600 font-bold mb-2 dark:text-sage-400">Intensity: ${e.inputs.intensity}</div>
                            <p class="text-sm text-gray-600 italic dark:text-gray-300">"${e.inputs.vent.substring(0, 60)}..."</p>
                        </div>`;
                    } else {
                        return `<div class="bg-white p-4 rounded-xl shadow border-l-4 border-purple-500 relative mb-3 dark:bg-gray-800">
                            <div class="flex justify-between mb-1"><span class="font-bold text-gray-800 dark:text-white">Journal</span><span class="text-xs text-gray-400">${date}</span></div>
                            <p class="text-sm text-gray-800 mb-1 font-medium dark:text-gray-200">${e.prompt}</p>
                            <p class="text-sm text-gray-600 italic dark:text-gray-300">"${e.text.substring(0, 60)}..."</p>
                        </div>`;
                    }
                }).join('');
            },
            
            clear: function() {
                if(confirm("Delete ALL entries?")) { localStorage.removeItem('lunaVault'); window.location.reload(); }
            }
        };

        const Decoder = {
            run: function() {
                const b = document.getElementById('in-behavior').value;
                if(!b) return alert("Please select a behavior.");
                
                const intensity = document.getElementById('in-intensity').value;
                document.getElementById('btn-decode').innerText = "Analyzing...";
                
                setTimeout(() => {
                    const data = LOGIC_DB[b] || LOGIC_DB['panic_clinging'];
                    State.currentResult = { ...data };
                    
                    document.getElementById('out-pattern').innerText = data.name;
                    document.getElementById('out-subtype').innerText = `${data.subtype} ‚Ä¢ Intensity: ${intensity}`;
                    document.getElementById('out-what').innerText = data.what;
                    document.getElementById('out-why').innerText = data.why;

                    document.getElementById('btn-decode').innerText = "Decode My Pattern";
                    App.navigateTo('screen-result');
                }, 600);
            }
        };

        const App = {
            navigateTo: function(screenId) {
                document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
                document.getElementById(screenId).classList.remove('hidden');
                if(screenId === 'screen-vault') Vault.switchTab('free');
            },
            startCheckIn: () => App.navigateTo('screen-checkin'),
            startPremiumJournal: () => {
                if(!State.premium) return UI.showPaywall();
                App.navigateTo('screen-premium-journal');
            },
            showModule: (type) => {
                const r = State.currentResult;
                let content = "";
                if (type === "Pattern Interrupter") content = r.interrupt[Math.floor(Math.random() * r.interrupt.length)];
                else if (type === "Daily Practice") content = r.practice;
                else if (type === "Anchor for Today") content = `"${r.anchor}"`;
                
                document.getElementById('mod-title').innerText = type;
                document.getElementById('mod-content').innerText = content;
                App.navigateTo('screen-module');
            },
            startVoice: (id) => {
                const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.onstart = () => UI.toast("Listening...");
                recognition.onresult = (event) => {
                    document.getElementById(id).value += " " + event.results[0][0].transcript;
                };
                recognition.start();
            },
            checkCode: () => {
                if (document.getElementById('accessCode').value.toUpperCase() === 'LUNA2025') {
                    State.premium = true; localStorage.setItem('lunaPremium', 'true');
                    alert("Unlocked!"); UI.closePaywall(); 
                    document.getElementById('upgradeBtn').classList.add('hidden');
                    document.getElementById('lock-icon').classList.add('hidden');
                } else { alert("Incorrect Code"); }
            },
            reset: () => {
                document.getElementById('in-vent').value = "";
                App.navigateTo('screen-home');
            }
        };

        const UI = {
            toast: (msg) => { const t = document.getElementById('toast'); t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); },
            showPaywall: () => document.getElementById('paywallModal').classList.remove('hidden'),
            closePaywall: () => document.getElementById('paywallModal').classList.add('hidden'),
            toggleModal: (id) => { const m = document.getElementById(id); m.classList.contains('hidden') ? m.classList.remove('hidden') : m.classList.add('hidden'); },
            toggleDark: () => {
                document.documentElement.classList.toggle('dark');
                UI.toast("Dark Mode Toggled");
            }
        };

        // Init
        if(State.premium) {
            document.getElementById('upgradeBtn').classList.add('hidden');
            document.getElementById('lock-icon').classList.add('hidden');
        }
        App.navigateTo('screen-home');

    </script>
</body>
</html>