<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pattern Breaker | LunaSoul</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÉ</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8A9A5B">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { sage: { 50: '#f4f7f4', 100: '#E8EDE6', 500: '#8A9A5B', 600: '#738249', 700: '#5F6F46', 900: '#2f3823' }, sand: '#F5F5F0' } } }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F5F5F0; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Slider Dynamic Colors */
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #fff; border: 2px solid currentColor; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #E8EDE6; border-radius: 2px; }
        
        #toast { visibility: hidden; min-width: 250px; transform: translateX(-50%); background-color: #2f3823; color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 100; left: 50%; bottom: 30px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col mx-auto max-w-md bg-sand transition-colors duration-300">

    <nav class="w-full bg-sage-500 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-2 cursor-pointer" onclick="App.navigateTo('screen-home')">
            <h1 class="font-semibold text-lg tracking-wide">Pattern Breaker</h1>
        </div>
        <div class="flex gap-3">
             <button id="upgradeBtn" onclick="UI.showPaywall()" class="bg-white text-sage-700 px-3 py-1 rounded text-xs font-bold shadow hidden">Upgrade</button>
             <button onclick="App.navigateTo('screen-settings')" class="hover:text-sage-200"><i class="fas fa-cog"></i></button>
        </div>
    </nav>

    <div id="progress-container" class="w-full h-1.5 bg-gray-200 hidden">
        <div id="progress-fill" class="h-1.5 bg-sage-500 w-0 transition-all duration-500"></div>
    </div>

    <main id="app-container" class="flex-grow p-4 pb-24 relative overflow-y-auto">

        <div id="screen-home" class="fade-in">
            <div class="text-center mt-8 mb-8">
                <div class="w-24 h-24 bg-sage-100 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-inner">üçÉ</div>
                <h2 class="text-3xl font-bold text-sage-700">Welcome Home.</h2>
                <p class="text-gray-600 mt-4 text-sm leading-relaxed px-4">
                    Decode your pattern, interrupt the spiral, and return to safety in 60 seconds.
                </p>
            </div>
            
            <button onclick="App.startCheckIn()" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-105 mb-4">
                Start Check-In
            </button>

            <a href="https://angel-s-site-4148.thinkific.com/courses/understanding-relationship-patterns" target="_blank" class="block w-full bg-white border border-sage-200 text-sage-700 font-bold py-3 rounded-xl shadow-sm text-center text-sm mb-6 hover:bg-sage-50 transition">
                Take the Full Course
            </a>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="App.navigateTo('screen-vault')" class="bg-white p-3 rounded-lg shadow text-sm font-semibold text-gray-700"><i class="fas fa-book mr-2"></i>Vault</button>
                <button onclick="App.navigateTo('screen-rewrite')" class="bg-white p-3 rounded-lg shadow text-sm font-semibold text-gray-700"><i class="fas fa-pen-fancy mr-2"></i>Rewrite</button>
            </div>
        </div>

        <div id="screen-checkin" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-6">Check-In</h2>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">What's happening? (Vent here)</label>
                <textarea id="in-vent" rows="3" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-base outline-none shadow-sm" placeholder="I'm spiraling because..."></textarea>
            </div>

            <div class="mb-8">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs font-bold text-gray-400 uppercase">Intensity</label>
                    <span id="intensity-val" class="font-bold text-sage-600 text-lg">5</span>
                </div>
                <div class="bg-white p-4 rounded-xl border border-sage-200">
                    <input type="range" id="in-intensity" min="1" max="10" value="5" oninput="UI.updateSlider(this)">
                    <div class="flex justify-between text-xs text-gray-400 mt-2"><span>Low</span><span>Severe</span></div>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">My First Reaction is...</label>
                <select id="in-behavior" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-sm outline-none shadow-sm">
                    <option value="" disabled selected>Select behavior...</option>
                    <option value="hyper_independence">Pulling away / Isolating</option>
                    <option value="panic_clinging">Clinging / Panic texting</option>
                    <option value="shutdown">Emotional shutdown / Numbness</option>
                    <option value="over_giving">Over giving (to avoid rejection)</option>
                    <option value="over_explaining">Over explaining (to feel safe)</option>
                    <option value="distrust">Checking / Scanning for danger</option>
                    <option value="self_blame">Self-blame / "I'm too much"</option>
                </select>
            </div>

            <button onclick="Decoder.run()" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-4 rounded-xl shadow-lg mt-4 flex justify-center items-center gap-2">
                <span id="decode-btn-text">Decode My Pattern</span>
                <i id="decode-spinner" class="fas fa-spinner fa-spin hidden"></i>
            </button>
        </div>

        <div id="screen-decode" class="hidden fade-in pb-10">
            <div class="bg-sage-100 p-6 rounded-xl mb-6 border-l-4 border-sage-500 shadow-sm relative">
                <p class="text-xs uppercase tracking-widest text-gray-500 mb-1">Detected Pattern</p>
                <h2 id="out-pattern" class="text-2xl font-bold text-sage-800 mb-2">...</h2>
                <div class="flex items-center gap-2">
                    <span id="out-badge" class="bg-sage-200 text-sage-800 text-xs px-2 py-1 rounded font-bold">Intensity: 5</span>
                </div>
            </div>

            <div class="bg-sage-600 p-5 rounded-xl shadow-lg mb-6 text-white text-center">
                <h3 class="font-bold text-lg mb-1">Go Deeper</h3>
                <p class="text-sm opacity-90 mb-3">You've identified the pattern. Now learn how to heal the root cause permanently.</p>
                <a href="https://angel-s-site-4148.thinkific.com/courses/understanding-relationship-patterns" target="_blank" class="inline-block bg-white text-sage-700 font-bold px-6 py-2 rounded-lg text-sm hover:bg-gray-100 transition">
                    View Course Modules
                </a>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm mb-6">
                <h3 class="font-bold text-gray-800 text-sm mb-2 uppercase border-b pb-2">What's Happening</h3>
                <p id="out-what" class="text-sm text-gray-600 leading-relaxed mb-4">...</p>
                <h3 class="font-bold text-gray-800 text-sm mb-2 uppercase border-b pb-2">Why It Activates</h3>
                <p id="out-why" class="text-sm text-gray-600 leading-relaxed">...</p>
            </div>

            <button onclick="App.navigateTo('screen-regulate')" class="w-full bg-sage-500 text-white font-bold py-3 rounded-xl shadow-lg mb-3">
                Next: Regulate Nervous System
            </button>
            <button onclick="Vault.saveResult()" class="w-full text-sage-600 text-sm font-bold mb-4">Save Result</button>
        </div>

        <div id="screen-regulate" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-4">Regulate</h2>
            
            <div class="bg-sage-500 text-white p-5 rounded-xl shadow-lg mb-4 relative">
                <h3 class="font-bold text-sm uppercase opacity-90 mb-2"><i class="fas fa-bolt mr-2"></i>Micro-Interrupter</h3>
                <p id="out-interrupt" class="font-medium text-lg leading-relaxed">...</p>
                <button onclick="Decoder.regenerate('interrupt')" class="absolute top-4 right-4 text-white opacity-70 hover:opacity-100"><i class="fas fa-sync-alt"></i></button>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm mb-4 border border-sage-100 relative">
                <h3 class="font-bold text-gray-700 text-sm uppercase mb-2"><i class="fas fa-leaf mr-2 text-sage-500"></i>Daily Practice</h3>
                <p id="out-practice" class="text-sm text-gray-700 font-medium">...</p>
                <button onclick="Decoder.regenerate('practice')" class="absolute top-4 right-4 text-gray-400 hover:text-sage-500"><i class="fas fa-sync-alt"></i></button>
            </div>

            <div class="text-center p-6 bg-sand rounded-xl border-2 border-dashed border-sage-200 mb-6 relative">
                <p class="text-xs font-bold text-gray-400 uppercase mb-2">Anchor for Today</p>
                <p id="out-anchor" class="text-lg font-serif italic text-sage-800">"..."</p>
                <button onclick="Decoder.regenerate('anchor')" class="absolute top-2 right-2 text-gray-300 hover:text-sage-500"><i class="fas fa-sync-alt"></i></button>
            </div>

            <button onclick="App.navigateTo('screen-integrate')" class="w-full bg-sage-500 text-white font-bold py-3 rounded-xl shadow-lg mb-3">
                Next: Integrate & Journal
            </button>
            <button onclick="App.navigateTo('screen-decode')" class="w-full text-center text-gray-400 text-sm">Back</button>
        </div>

        <div id="screen-integrate" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-4">Integrate</h2>
            
            <div class="bg-white p-4 rounded-lg border border-sage-200 mb-4">
                <p class="text-xs font-bold text-sage-500 uppercase mb-1">Reflection Prompt</p>
                <p id="out-prompt" class="text-sm text-gray-700 italic font-semibold">...</p>
            </div>

            <textarea id="journal-input" rows="10" class="w-full p-4 bg-white border border-sage-200 rounded-lg text-base focus:ring-2 focus:ring-sage-500 outline-none mb-4 shadow-inner" placeholder="Reflect here..."></textarea>

            <button onclick="Vault.saveJournal()" class="w-full bg-sage-500 text-white font-bold py-3 rounded-xl shadow-lg mb-3">Save to Vault</button>
            
            <button onclick="App.navigateTo('screen-rewrite')" class="w-full border border-sage-300 text-sage-700 py-3 rounded-xl mb-3 flex justify-center items-center gap-2">
                <i class="fas fa-pen-fancy"></i> Need to send a text? Use Rewrite
            </button>
        </div>

        <div id="screen-rewrite" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-4">Regulation Rewrite</h2>
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                <p class="text-xs text-gray-500 mb-2">Paste the anxious/angry text you *want* to send. We will rewrite it from a regulated state.</p>
                <textarea id="rewrite-input" rows="4" class="w-full p-3 border border-gray-200 rounded-lg text-sm bg-gray-50" placeholder="e.g. Why are you ignoring me?? I need an answer now."></textarea>
            </div>
            <button onclick="Rewrite.generate()" class="w-full bg-sage-500 text-white font-bold py-3 rounded-xl shadow-lg mb-6">Rewrite It</button>
            
            <div id="rewrite-output" class="hidden">
                <h3 class="text-sm font-bold text-sage-700 mb-2">Try this instead:</h3>
                <div class="bg-sage-50 p-4 rounded-xl border border-sage-200 mb-4">
                    <p id="rewrite-result" class="text-sage-900 font-medium">...</p>
                </div>
                <button onclick="UI.copyToClipboard('rewrite-result')" class="text-xs text-gray-400 underline w-full text-center">Copy to Clipboard</button>
            </div>
            
            <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-gray-400 text-sm mt-6">Back Home</button>
        </div>

        <div id="screen-vault" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-sage-700">The Vault</h2>
                <button onclick="App.navigateTo('screen-home')" class="text-sm text-gray-400">Back</button>
            </div>
            
            <div class="relative mb-4">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                <input type="text" id="vault-search" onkeyup="Vault.render()" placeholder="Search entries..." class="w-full pl-10 p-2 bg-white border border-gray-200 rounded-lg text-sm">
            </div>

            <div id="vault-list" class="space-y-4 pb-20"></div>
        </div>

        <div id="screen-settings" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-6">Settings</h2>
            <div class="bg-white rounded-xl shadow divide-y divide-gray-100">
                <div class="p-4 flex justify-between items-center">
                    <span>Dark Mode</span>
                    <button onclick="UI.toggleDark()" class="text-sage-500 font-bold text-xs">Toggle</button>
                </div>
                <div class="p-4 flex justify-between items-center">
                    <span class="text-red-400">Clear Data</span>
                    <button onclick="Vault.clear()" class="text-red-500 font-bold text-xs">Clear</button>
                </div>
            </div>
            
            <div class="mt-8 text-center border-t pt-6">
                 <p class="text-xs text-gray-400 mb-2">Version 9.2</p>
                 <a href="https://angel-s-site-4148.thinkific.com/courses/understanding-relationship-patterns" target="_blank" class="text-sage-600 font-bold text-sm">Visit Course Page</a>
            </div>
            
            <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-gray-400 text-sm mt-6">Back</button>
        </div>

    </main>

    <div id="toast">Action Saved</div>

    <div id="paywallModal" class="fixed inset-0 bg-black bg-opacity-60 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Unlock the Vault</h2>
            <p class="text-gray-600 mb-6 text-sm">Save your entries and access journaling. Included for course students.</p>
            <a href="https://buy.stripe.com/4gM5kDfQX6uj2Ghb829fW00" target="_blank" class="block w-full bg-sage-500 text-white font-bold py-3 rounded-lg mb-4 hover:bg-sage-600">Subscribe for $5/mo</a>
            <div class="flex gap-2">
                <input type="text" id="accessCode" placeholder="STUDENT CODE" class="flex-grow border border-gray-300 rounded p-2 text-sm uppercase">
                <button onclick="checkCode()" class="bg-gray-800 text-white px-4 rounded text-sm">Unlock</button>
            </div>
            <button onclick="closePaywall()" class="mt-4 text-xs text-gray-400 underline">Close</button>
        </div>
    </div>

    <script>
        // --- 1. APP STATE ---
        const State = {
            premium: localStorage.getItem('lunaPremium') === 'true',
            inputs: { vent: "", intensity: 5, behavior: "" },
            currentResult: null
        };

        // --- 2. DECODER ENGINE (The Brain) ---
        const LOGIC_DB = {
            'hyper_independence': { name: "Hyper Independence", subtype: "Protection Mode", 
                what: "You are pushing others away to maintain control.", why: "Early on, you learned no one was coming to save you.", 
                interrupt: ["Drop your shoulders.", "Say: 'It is safe to let people in.'"], 
                practice: "The 5% Rule: Ask for help with one tiny thing.", anchor: "I do not have to carry it all.", prompt: "What am I afraid will happen if I admit I need support?" },
            'panic_clinging': { name: "Anxious Grasping", subtype: "Fight Mode", 
                what: "Your nervous system is screaming. You feel an urgent need to 'fix' it.", why: "An attachment wound is being touched. Distance equals danger.", 
                interrupt: ["Put the phone down.", "Push hands against a wall."], 
                practice: "Self-Soothing: Hand on chest, say 'I am here.'", anchor: "My safety is inside me, not in their response.", prompt: "What am I trying to earn from them that I can give myself?" },
            'shutdown': { name: "Emotional Shutdown", subtype: "Freeze Mode", 
                what: "You are going numb. You feel foggy or checked out.", why: "You learned to disappear to survive overwhelming pain.", 
                interrupt: ["Shake your hands vigorously.", "Wrap in a blanket."], 
                practice: "Orientation: Name 3 colors out loud.", anchor: "It is safe to be in my body.", prompt: "What feeling am I numbing out to avoid?" },
            'over_explaining': { name: "Over-Explaining", subtype: "Fawn Mode", 
                what: "You are over-talking to manage their emotions.", why: "You learned your needs were 'too much'.", 
                interrupt: ["Stop talking. Take a breath.", "Tongue to roof of mouth."], 
                practice: "The Pause: Count to 5 before responding.", anchor: "I do not need to explain my existence.", prompt: "Where am I shrinking myself?" },
            'distrust': { name: "Hyper-Vigilance", subtype: "Scan Mode", 
                what: "You are waiting for the other shoe to drop.", why: "Chaos feels familiar; stability feels suspicious. Your nervous system is wired to scan for danger.", 
                interrupt: ["Look around the room. Find safety cues.", "Fact-check: Real vs Imagined?"], 
                practice: "Write facts vs story.", anchor: "I can trust myself to handle whatever happens.", prompt: "What story am I inventing?" },
            'self_blame': { name: "Internalized Blame", subtype: "Shame Mode", 
                what: "You are taking 100% responsibility.", why: "It felt safer to believe 'I am bad' than 'They are unsafe'.", 
                interrupt: ["Say: 'This is not all my fault.'", "Push feet into floor."], 
                practice: "Compassion: Talk to yourself like a friend.", anchor: "I am not the problem.", prompt: "What responsibility is not mine?" },
            'over_giving': { name: "Over Giving", subtype: "Fawn Mode", 
                what: "You are over-giving to secure your place.", why: "You learned love was conditional on being useful.", 
                interrupt: ["Clench fists then release.", "Ask: Do I really want to do this?"], 
                practice: "Say No to one small thing.", anchor: "I am loved for who I am, not what I do.", prompt: "What am I trying to buy with my generosity?" }
        };

        const Decoder = {
            run: function() {
                const b = document.getElementById('in-behavior').value;
                if(!b) return alert("Please select a behavior.");
                
                State.inputs.behavior = b;
                State.inputs.vent = document.getElementById('in-vent').value;
                
                UI.setLoading(true);
                setTimeout(() => {
                    const data = LOGIC_DB[b] || LOGIC_DB['panic_clinging'];
                    State.currentResult = { ...data, date: new Date(), intensity: State.inputs.intensity };
                    Decoder.populateReport();
                    UI.setLoading(false);
                    App.navigateTo('screen-decode');
                }, 800);
            },
            populateReport: function() {
                const r = State.currentResult;
                UI.setText('out-pattern', r.name);
                UI.setText('out-subtype', r.subtype);
                UI.setText('out-badge', `Intensity: ${r.intensity}`);
                UI.setText('out-what', r.what);
                UI.setText('out-why', r.why);
                
                UI.setText('out-interrupt', r.interrupt[Math.floor(Math.random() * r.interrupt.length)]);
                UI.setText('out-practice', r.practice);
                UI.setText('out-anchor', `"${r.anchor}"`);
                UI.setText('out-prompt', r.prompt);
                
                const prefill = State.inputs.vent ? `[Initial Vent]: ${State.inputs.vent}\n\n` : "";
                document.getElementById('journal-input').value = prefill;
            },
            regenerate: function(type) {
                const r = State.currentResult;
                if(type === 'interrupt') UI.setText('out-interrupt', r.interrupt[Math.floor(Math.random() * r.interrupt.length)]);
                // Add more regen logic if needed
                UI.toast("Refreshed");
            }
        };

        // --- 3. REWRITE ENGINE ---
        const Rewrite = {
            generate: function() {
                const input = document.getElementById('rewrite-input').value.toLowerCase();
                if(!input) return alert("Please enter text.");
                
                let output = "I'm feeling a bit overwhelmed and need to pause. Let's connect later.";
                if(input.includes("ignore") || input.includes("answer")) {
                    output = "I'm noticing I'm feeling anxious about the silence. I'd love to check in when you have a moment.";
                } else if(input.includes("why") || input.includes("never")) {
                    output = "I'm feeling disconnected and want to understand what's happening. Can we talk?";
                } else if(input.includes("hate") || input.includes("mad")) {
                    output = "I'm feeling really hurt right now and need some time to process before we speak.";
                }

                document.getElementById('rewrite-result').innerText = output;
                document.getElementById('rewrite-output').classList.remove('hidden');
            }
        };

        // --- 4. VAULT (Storage) ---
        const Vault = {
            data: JSON.parse(localStorage.getItem('lunaVault') || '[]'),
            saveResult: function() {
                if(!State.premium) return UI.showPaywall();
                Vault.add({ type: 'Result', title: State.currentResult.name, body: State.currentResult.what });
            },
            saveJournal: function() {
                if(!State.premium) return UI.showPaywall();
                const text = document.getElementById('journal-input').value;
                if(!text) return alert("Write something first.");
                Vault.add({ type: 'Journal', title: 'Integration Entry', body: text });
            },
            add: function(entry) {
                entry.date = new Date();
                entry.intensity = State.inputs.intensity;
                Vault.data.unshift(entry);
                localStorage.setItem('lunaVault', JSON.stringify(Vault.data));
                UI.toast("Saved to Vault");
            },
            render: function() {
                const term = document.getElementById('vault-search').value.toLowerCase();
                const filtered = Vault.data.filter(e => e.body.toLowerCase().includes(term) || e.title.toLowerCase().includes(term));
                const list = document.getElementById('vault-list');
                
                if(filtered.length === 0) return list.innerHTML = '<p class="text-center text-gray-400 mt-10">Empty.</p>';
                
                list.innerHTML = filtered.map((e, i) => `
                    <div class="bg-white p-4 rounded-xl shadow border-l-4 border-sage-500 relative">
                        <div class="flex justify-between mb-2">
                            <span class="font-bold text-gray-800">${e.title}</span>
                            <span class="text-xs text-gray-400">${new Date(e.date).toLocaleDateString()}</span>
                        </div>
                        <p class="text-xs font-bold text-sage-500 uppercase mb-1">${e.type} (Level ${e.intensity || 5})</p>
                        <p class="text-sm text-gray-800 whitespace-pre-wrap mb-3">${e.body.substring(0, 100)}...</p>
                        <div class="flex gap-3 border-t pt-2">
                            <button onclick="Vault.exportPDF(${i})" class="text-xs text-sage-600"><i class="fas fa-file-pdf"></i> PDF</button>
                            <button onclick="Vault.delete(${i})" class="text-xs text-red-400"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            },
            delete: function(index) {
                if(confirm("Delete this?")) {
                    Vault.data.splice(index, 1);
                    localStorage.setItem('lunaVault', JSON.stringify(Vault.data));
                    Vault.render();
                }
            },
            clear: function() {
                if(confirm("Delete ALL entries?")) {
                    localStorage.removeItem('lunaVault');
                    Vault.data = [];
                    window.location.reload();
                }
            },
            exportPDF: function(index) {
                const e = Vault.data[index];
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(20); doc.text("LunaSoul Entry", 10, 20);
                doc.setFontSize(12); doc.text(`Date: ${new Date(e.date).toLocaleString()}`, 10, 30);
                doc.text(`Pattern: ${e.title}`, 10, 40);
                doc.text(doc.splitTextToSize(e.body, 180), 10, 60);
                doc.save("lunasoul-entry.pdf");
                UI.toast("PDF Downloaded");
            }
        };

        // --- 5. UI & APP CONTROLLER ---
        const UI = {
            setText: (id, val) => document.getElementById(id).innerText = val,
            setLoading: (loading) => {
                const btn = document.getElementById('decode-btn-text');
                const spin = document.getElementById('decode-spinner');
                if(loading) { btn.innerText = "Analyzing..."; spin.classList.remove('hidden'); }
                else { btn.innerText = "Decode My Pattern"; spin.classList.add('hidden'); }
            },
            toast: (msg) => {
                const t = document.getElementById("toast");
                t.innerText = msg; t.className = "show";
                setTimeout(() => t.className = t.className.replace("show", ""), 3000);
            },
            updateSlider: (el) => {
                document.getElementById('intensity-val').innerText = el.value;
                const colors = ['#4ade80', '#fbbf24', '#f87171'];
                el.style.accentColor = el.value < 4 ? colors[0] : el.value < 8 ? colors[1] : colors[2];
            },
            showPaywall: () => document.getElementById('paywallModal').classList.remove('hidden'),
            closePaywall: () => document.getElementById('paywallModal').classList.add('hidden'),
            toggleDark: () => document.documentElement.classList.toggle('dark'),
            copyToClipboard: (id) => {
                navigator.clipboard.writeText(document.getElementById(id).innerText);
                UI.toast("Copied!");
            }
        };

        const App = {
            navigateTo: function(screenId) {
                // Progress Bar
                const progressMap = { 'screen-home': '0%', 'screen-checkin': '33%', 'screen-decode': '66%', 'screen-regulate': '100%', 'screen-integrate': '100%' };
                const fill = document.getElementById('progress-fill');
                const bar = document.getElementById('progress-container');
                
                if (progressMap[screenId]) {
                    bar.classList.remove('hidden');
                    setTimeout(() => fill.style.width = progressMap[screenId], 50);
                } else {
                    bar.classList.add('hidden');
                }

                // Switch Screen
                document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(screenId);
                if(target) target.classList.remove('hidden');
                
                if(screenId === 'screen-vault') Vault.render();
            },
            startCheckIn: () => App.navigateTo('screen-checkin'),
            checkCode: () => {
                if (document.getElementById('accessCode').value.toUpperCase() === 'LUNA2025') {
                    State.premium = true; localStorage.setItem('lunaPremium', 'true');
                    alert("Unlocked!"); UI.closePaywall(); document.getElementById('upgradeBtn').classList.add('hidden');
                } else { alert("Incorrect Code"); }
            }
        };

        // INIT
        if(State.premium) document.getElementById('upgradeBtn').classList.add('hidden');
        App.navigateTo('screen-home');

    </script>
</body>
</html>