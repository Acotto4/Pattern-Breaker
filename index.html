<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>Pattern Breaker | LunaSoul</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÉ</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8A9A5B">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        window.onerror = function(msg, url, line) { alert("Error: " + msg); return true; };
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { sage: { 50: '#f4f7f4', 100: '#E8EDE6', 500: '#8A9A5B', 600: '#738249', 700: '#5F6F46', 900: '#2f3823' }, sand: '#F5F5F0' } } } }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F5F5F0; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #toast { visibility: hidden; min-width: 250px; transform: translateX(-50%); background-color: #2f3823; color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 100; left: 50%; bottom: 30px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #fff; border: 2px solid currentColor; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .mic-active { color: #ef4444 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col mx-auto max-w-md bg-sand transition-colors duration-300 dark:bg-gray-900 dark:text-gray-100">

    <nav class="w-full bg-sage-500 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-2 cursor-pointer" onclick="App.navigateTo('screen-home')">
            <h1 class="font-semibold text-lg tracking-wide">Pattern Breaker</h1>
        </div>
        <div class="flex gap-3 items-center">
             <button onclick="App.toggleLang()" class="text-xs font-bold border border-white px-2 py-1 rounded hover:bg-white hover:text-sage-500 transition">üåê <span id="lang-display">EN</span></button>
             <button onclick="App.navigateTo('screen-settings')" class="hover:text-sage-200"><i class="fas fa-cog"></i></button>
        </div>
    </nav>

    <div id="progress-container" class="w-full h-1.5 bg-gray-200 hidden"><div id="progress-fill" class="h-1.5 bg-sage-500 w-0 transition-all duration-500"></div></div>

    <main id="app-container" class="flex-grow p-4 pb-24 relative overflow-y-auto">

        <div id="screen-home" class="fade-in">
            <div class="text-center mt-8 mb-8">
                <div class="w-24 h-24 bg-sage-100 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-inner text-sage-600">üçÉ</div>
                <h2 class="text-3xl font-bold text-sage-700 dark:text-sage-300" data-i18n="welcome_title">Welcome Home.</h2>
                <p class="text-gray-600 dark:text-gray-400 mt-4 text-sm leading-relaxed px-4" data-i18n="welcome_text">Decode your abandonment patterns, interrupt the spiral, and return to safety.</p>
            </div>
            <button onclick="App.navigateTo('screen-safety')" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-105 mb-4" data-i18n="btn_start">Start Check-In (Free)</button>
            
            <button onclick="App.startPremiumJournal()" class="w-full bg-white border-2 border-sage-500 text-sage-700 font-bold py-4 rounded-xl shadow-sm transition mb-4 flex justify-center items-center gap-2 dark:bg-gray-800 dark:border-sage-400 dark:text-sage-300">
                <i class="fas fa-pen-nib"></i> <span data-i18n="btn_journal">Guided Journaling</span> <span id="lock-icon" class="text-xs ml-1">üîí</span>
            </button>

            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="App.navigateTo('screen-vault')" class="bg-white p-3 rounded-lg shadow text-sm font-semibold text-gray-700 dark:bg-gray-800 dark:text-gray-300"><i class="fas fa-book mr-2"></i><span data-i18n="btn_vault">Vault</span></button>
                <button onclick="UI.toggleModal('modal-about')" class="bg-white p-3 rounded-lg shadow text-sm font-semibold text-gray-700 dark:bg-gray-800 dark:text-gray-300"><i class="fas fa-info-circle mr-2"></i><span data-i18n="btn_about">About</span></button>
            </div>
            <div class="mt-6 text-center">
                <a href="https://angel-s-site-4148.thinkific.com/courses/understanding-relationship-patterns" target="_blank" class="text-xs text-sage-600 font-bold underline dark:text-sage-400" data-i18n="link_course">Take the Full Course</a>
            </div>
            <p class="text-center text-xs text-gray-300 mt-8">v27.0</p>
        </div>

        <div id="screen-safety" class="hidden fade-in pt-6">
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-sage-500 dark:bg-gray-800">
                <h2 class="text-xl font-bold text-gray-800 mb-4 dark:text-white"><i class="fas fa-heart text-sage-500 mr-2"></i><span data-i18n="safety_title">Emotional Safety</span></h2>
                <p class="text-sm text-gray-600 leading-relaxed mb-4 dark:text-gray-300" data-i18n="safety_text">This is a self-guided tool, not therapy.</p>
                <div class="bg-sage-50 p-3 rounded-lg mb-6 dark:bg-gray-700">
                    <h3 class="text-xs font-bold text-sage-700 uppercase mb-1 dark:text-sage-300"><i class="fas fa-lock mr-1"></i> <span data-i18n="privacy_title">Privacy Notice</span></h3>
                    <p class="text-xs text-gray-600 dark:text-gray-400" data-i18n="privacy_text">Your data is stored only on this device.</p>
                </div>
                <button onclick="App.grantConsent()" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-3 rounded-lg" data-i18n="btn_agree">I Understand & Proceed</button>
                <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-4 dark:text-sage-400" data-i18n="btn_back">Back</button>
            </div>
        </div>

        <div id="screen-intake" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-6 dark:text-sage-300" data-i18n="checkin_title">Check-In</h2>
            <div class="mb-6 relative">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2" data-i18n="label_vent">What's happening? (Vent here)</label>
                <textarea id="in-vent" rows="3" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-base outline-none shadow-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white"></textarea>
                <button onclick="App.startVoice('in-vent')" class="absolute bottom-3 right-3 text-gray-400 hover:text-sage-500"><i class="fas fa-microphone"></i></button>
            </div>
            <div class="mb-8">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2" data-i18n="label_intensity">Intensity (1-10)</label>
                <input type="range" id="in-intensity" min="1" max="10" value="5" class="w-full" oninput="document.getElementById('intensity-val').innerText = this.value">
                <p class="text-center font-bold text-sage-600 mt-2 dark:text-sage-400"><span data-i18n="level">Level</span>: <span id="intensity-val">5</span></p>
            </div>
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2" data-i18n="label_reaction">First Reaction?</label>
                <select id="in-behavior" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-sm outline-none shadow-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                    <option value="hyper_independence" data-i18n="opt_indep">Pulling away / Isolating</option>
                    <option value="panic_clinging" data-i18n="opt_cling">Clinging / Panic texting</option>
                    <option value="shutdown" data-i18n="opt_shut">Shutdown / Numb</option>
                    <option value="over_giving" data-i18n="opt_give">Over-giving</option>
                    <option value="over_explaining" data-i18n="opt_explain">Over-explaining</option>
                    <option value="distrust" data-i18n="opt_distrust">Checking / Scanning</option>
                    <option value="self_blame" data-i18n="opt_blame">Self-blame</option>
                </select>
            </div>
            <button onclick="Decoder.run()" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-4 rounded-xl shadow-lg mt-4 flex justify-center items-center gap-2">
                <span id="decode-btn-text" data-i18n="btn_decode">Decode My Pattern</span>
                <i id="decode-spinner" class="fas fa-spinner fa-spin hidden"></i>
            </button>
            <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-4 dark:text-sage-400" data-i18n="btn_cancel">Cancel</button>
        </div>

        <div id="screen-result" class="hidden fade-in pb-10">
            <div class="bg-sage-100 p-6 rounded-xl mb-6 border-l-4 border-sage-500 shadow-sm dark:bg-gray-800 dark:border-sage-400">
                <p class="text-xs uppercase tracking-widest text-gray-500 mb-1 dark:text-gray-400" data-i18n="label_detected">Detected Pattern</p>
                <h2 id="out-pattern" class="text-2xl font-bold text-sage-800 mb-2 dark:text-white">...</h2>
                <div class="flex items-center gap-2">
                    <span id="out-badge" class="bg-sage-200 text-sage-800 text-xs px-2 py-1 rounded font-bold">Intensity: 5</span>
                </div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm mb-6 dark:bg-gray-800">
                <h3 class="font-bold text-gray-800 text-sm mb-2 border-b pb-2 dark:text-gray-200" data-i18n="label_what">What's Happening</h3>
                <p id="out-what" class="text-sm text-gray-600 leading-relaxed mb-4 dark:text-gray-300">...</p>
                <h3 class="font-bold text-gray-800 text-sm mb-2 border-b pb-2 dark:text-gray-200" data-i18n="label_why">Why It Activates</h3>
                <p id="out-why" class="text-sm text-gray-600 leading-relaxed dark:text-gray-300">...</p>
            </div>
            <div class="grid grid-cols-1 gap-3 mb-6">
                <button onclick="App.showModule('interrupt')" class="p-4 bg-sage-500 text-white rounded-xl shadow font-bold text-left flex justify-between"><span data-i18n="btn_interrupt">Pattern Interrupter</span><i class="fas fa-bolt"></i></button>
                <button onclick="App.showModule('practice')" class="p-4 bg-white border border-sage-200 rounded-xl shadow text-left flex justify-between dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200"><span data-i18n="btn_practice">Daily Practice</span><i class="fas fa-leaf text-sage-500"></i></button>
                <button onclick="App.showModule('anchor')" class="p-4 bg-white border border-sage-200 rounded-xl shadow text-left flex justify-between dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200"><span data-i18n="btn_anchor">Anchor for Today</span><i class="fas fa-anchor text-sage-500"></i></button>
                <button onclick="App.showModule('journal')" class="p-4 bg-white border border-sage-200 rounded-xl shadow text-left flex justify-between dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200"><span data-i18n="btn_journal_prompt">Journal Prompt</span><i class="fas fa-pen text-sage-500"></i></button>
            </div>
            <button onclick="Vault.saveFreeEntry()" class="w-full text-center text-sage-600 text-sm font-bold mb-4 dark:text-sage-400" data-i18n="btn_save_result">Save Result</button>
            <button onclick="App.reset()" class="w-full text-center text-gray-400 text-sm" data-i18n="btn_next_decode">Start Next Decode</button>
        </div>

        <div id="screen-module" class="hidden fade-in pt-6">
            <h2 id="mod-title" class="text-xl font-bold text-sage-700 mb-4 dark:text-sage-300">Module</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-sage-500 mb-6 dark:bg-gray-800">
                <p id="mod-content" class="text-lg font-medium text-gray-800 leading-relaxed dark:text-gray-200">...</p>
            </div>
            <div id="journal-area" class="hidden mb-4">
                <textarea id="journal-input-module" rows="10" class="w-full p-4 bg-white border border-sage-200 rounded-lg text-base focus:ring-2 focus:ring-sage-500 outline-none shadow-inner dark:bg-gray-800 dark:border-gray-600 dark:text-white"></textarea>
            </div>
            <button onclick="Vault.saveModuleEntry()" class="w-full bg-sage-500 text-white font-bold py-3 rounded-xl shadow-lg mb-3" data-i18n="btn_save_vault">Save to Vault</button>
            <button onclick="App.navigateTo('screen-result')" class="w-full text-sage-600 font-bold text-center dark:text-sage-400" data-i18n="btn_back">Back</button>
        </div>

        <div id="screen-premium-journal" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-4 dark:text-sage-300" data-i18n="btn_journal">Guided Journaling</h2>
            <textarea id="prem-text" rows="10" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-base focus:ring-2 focus:ring-sage-500 outline-none mb-4 dark:bg-gray-800 dark:border-gray-600 dark:text-white"></textarea>
            <button onclick="App.startVoice('prem-text')" class="block mb-4 text-gray-400 hover:text-sage-500"><i class="fas fa-microphone"></i></button>
            <button onclick="Vault.savePremiumEntry()" class="w-full bg-sage-500 text-white font-bold py-3 rounded-xl shadow-lg" data-i18n="btn_analyze">Analyze & Save</button>
            <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-4 dark:text-sage-400" data-i18n="btn_cancel">Cancel</button>
        </div>

        <div id="screen-vault" class="hidden fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-sage-700 dark:text-sage-300" data-i18n="btn_vault">The Vault</h2>
                <button onclick="App.navigateTo('screen-home')" class="text-sm text-sage-600 font-bold dark:text-sage-400" data-i18n="btn_back">Back</button>
            </div>
            <div class="flex mb-4 bg-white rounded-lg p-1 shadow-sm dark:bg-gray-800">
                <button onclick="Vault.switchTab('free')" id="tab-free" class="flex-1 py-2 text-xs font-bold rounded bg-sage-100 text-sage-700">Check-Ins</button>
                <button onclick="Vault.switchTab('premium')" id="tab-premium" class="flex-1 py-2 text-xs font-bold rounded text-gray-400">Journal</button>
            </div>
            <div id="vault-content" class="space-y-3 pb-20"></div>
        </div>

        <div id="screen-settings" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-6 dark:text-sage-300" data-i18n="settings_title">Settings</h2>
            <div class="bg-white rounded-xl shadow divide-y divide-gray-100 dark:bg-gray-800 dark:divide-gray-700">
                <div class="p-4 flex justify-between items-center">
                    <span class="text-gray-700 dark:text-gray-200" data-i18n="dark_mode">Dark Mode</span>
                    <button onclick="UI.toggleDark()" class="text-sage-500 font-bold text-xs bg-gray-100 dark:bg-gray-900 px-3 py-1 rounded">Toggle</button>
                </div>
                <div class="p-4 flex justify-between items-center">
                    <span class="text-red-400" data-i18n="clear_data">Clear Data</span>
                    <button onclick="Vault.clear()" class="text-red-500 font-bold text-xs bg-red-50 px-3 py-1 rounded">Clear</button>
                </div>
            </div>
            <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-6 dark:text-sage-400" data-i18n="btn_back">Back</button>
        </div>

        <div id="modal-about" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl p-6 max-w-sm w-full relative dark:bg-gray-800">
                <h2 class="text-xl font-bold text-sage-700 mb-4 dark:text-sage-300">About Pattern Breaker</h2>
                <p class="text-sm text-gray-600 mb-4 dark:text-gray-300">This tool helps you identify emotional patterns connected to abandonment wounds and offers self-guided practices to interrupt them.</p>
                <button onclick="UI.toggleModal('modal-about')" class="w-full bg-sage-500 text-white py-2 rounded-lg font-bold">Close</button>
            </div>
        </div>
        
        <div id="paywallModal" class="fixed inset-0 bg-black bg-opacity-60 z-[70] hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center dark:bg-gray-800">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 dark:text-white">Unlock Premium</h2>
                <a href="https://buy.stripe.com/4gM5kDfQX6uj2Ghb829fW00" target="_blank" class="block w-full bg-sage-500 text-white font-bold py-3 rounded-lg mb-4 hover:bg-sage-600">Subscribe</a>
                <div class="flex gap-2">
                    <input type="text" id="accessCode" placeholder="CODE" class="flex-grow border border-gray-300 rounded p-2 text-sm uppercase dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <button onclick="App.checkCode()" class="bg-gray-800 text-white px-4 rounded text-sm">Unlock</button>
                </div>
                <button onclick="UI.closePaywall()" class="mt-4 text-xs text-gray-400 underline">Close</button>
            </div>
        </div>
        <div id="toast">Saved</div>
    </main>

    <script>
        // TRANSLATIONS
        const LANG = {
            en: {
                welcome_title: "Welcome Home.", welcome_text: "Decode your abandonment patterns.", btn_start: "Start Check-In (Free)", btn_journal: "Guided Journaling", btn_vault: "Vault", btn_about: "About", link_course: "Take the Full Course",
                safety_title: "Emotional Safety", safety_text: "This is a self-guided tool, not therapy.", privacy_title: "Privacy Notice", privacy_text: "Data stored on device only.", btn_agree: "I Understand & Proceed", btn_back: "Back",
                checkin_title: "Check-In", label_vent: "What's happening? (Vent here)", label_intensity: "Intensity (1-10)", level: "Level", label_reaction: "First Reaction?", btn_decode: "Decode My Pattern", btn_cancel: "Cancel",
                label_detected: "Detected Pattern", label_what: "What's Happening", label_why: "Why It Activates", btn_interrupt: "Interrupter", btn_practice: "Daily Practice", btn_anchor: "Anchor", btn_journal_prompt: "Journal Prompt", btn_save_result: "Save Result", btn_next_decode: "Start Next Decode",
                btn_save_vault: "Save to Vault", btn_analyze: "Analyze & Save", btn_vault: "The Vault", settings_title: "Settings", dark_mode: "Dark Mode", clear_data: "Clear Data",
                opt_indep: "Pulling away / Isolating", opt_cling: "Clinging / Panic texting", opt_shut: "Shutdown / Numb", opt_give: "Over-giving", opt_explain: "Over-explaining", opt_distrust: "Checking / Scanning", opt_blame: "Self-blame"
            },
            es: {
                welcome_title: "Bienvenido a Casa.", welcome_text: "Decodifica tus patrones de abandono.", btn_start: "Iniciar Chequeo (Gratis)", btn_journal: "Diario Guiado", btn_vault: "B√≥veda", btn_about: "Acerca de", link_course: "Tomar el Curso Completo",
                safety_title: "Seguridad Emocional", safety_text: "Herramienta de autoayuda, no terapia.", privacy_title: "Aviso de Privacidad", privacy_text: "Datos guardados solo en este dispositivo.", btn_agree: "Entiendo y Procedo", btn_back: "Atr√°s",
                checkin_title: "Chequeo", label_vent: "¬øQu√© est√° pasando? (Desah√≥gate aqu√≠)", label_intensity: "Intensidad (1-10)", level: "Nivel", label_reaction: "¬øPrimera Reacci√≥n?", btn_decode: "Decodificar Patr√≥n", btn_cancel: "Cancelar",
                label_detected: "Patr√≥n Detectado", label_what: "Lo que sucede", label_why: "Por qu√© se activa", btn_interrupt: "Interruptor", btn_practice: "Pr√°ctica Diaria", btn_anchor: "Ancla", btn_journal_prompt: "Pregunta de Diario", btn_save_result: "Guardar Resultado", btn_next_decode: "Comenzar Nuevo",
                btn_save_vault: "Guardar en B√≥veda", btn_analyze: "Analizar y Guardar", btn_vault: "La B√≥veda", settings_title: "Configuraci√≥n", dark_mode: "Modo Oscuro", clear_data: "Borrar Datos",
                opt_indep: "Alejarse / Aislarse", opt_cling: "Aferrarse / P√°nico", opt_shut: "Apagado / Entumecido", opt_give: "Dar en exceso", opt_explain: "Explicar en exceso", opt_distrust: "Verificar / Escanear", opt_blame: "Culparse a s√≠ mismo"
            }
        };

        // LOGIC DB (DEEP + BILINGUAL)
        const LOGIC_DB = {
            'hyper_independence': {
                en: { name: "Hyper Independence", subtype: "Protection Mode", what: "You are pushing others away to maintain control. Your system registers 'needing' as 'unsafe'. You are fortifying your walls because vulnerability feels like a threat.", why: "This isn't about strength; it's a survival strategy. Early on, you likely learned that no one was coming to save you, so you decided to become your own savior. Your nervous system imprinted 'aloneness' as the only safety.", interrupt: "Drop your shoulders. Unclench your jaw. Say out loud: 'It is safe to let people in, just a little.'", practice: "The 5% Rule: Ask for help with one tiny thing today. It can be as simple as asking someone to pass the salt. Notice that you survived the request.", anchor: "I do not have to carry it all to be safe.", prompt: "What story am I telling myself about what will happen if I admit I need support right now?" },
                es: { name: "Hiperindependencia", subtype: "Modo Protecci√≥n", what: "Est√°s alejando a los dem√°s para mantener el control. Tu sistema registra 'necesitar' como 'inseguro'. Est√°s fortificando tus muros porque la vulnerabilidad se siente como una amenaza.", why: "Esto no se trata de fuerza; es una estrategia de supervivencia. Al principio, probablemente aprendiste que nadie vendr√≠a a salvarte, as√≠ que decidiste convertirte en tu propio salvador. Tu sistema nervioso imprimi√≥ la 'soledad' como la √∫nica seguridad.", interrupt: "Baja los hombros. Desaprieta la mand√≠bula. Di en voz alta: 'Es seguro dejar entrar a la gente, solo un poco'.", practice: "La Regla del 5%: Pide ayuda con una cosa peque√±a hoy. Puede ser tan simple como pedirle a alguien que pase la sal. Nota que sobreviviste a la petici√≥n.", anchor: "No tengo que cargar todo solo para estar a salvo.", prompt: "¬øQu√© historia me estoy contando sobre lo que suceder√° si admito que necesito apoyo ahora mismo?" }
            },
            'panic_clinging': {
                en: { name: "Anxious Grasping", subtype: "Fight Mode Activation", what: "Your nervous system is screaming. You feel an urgent, frantic need to 'fix' the connection immediately. This is not love; this is a fight response to the threat of abandonment.", why: "This is an attachment wound being touched. Your child-self learned that 'distance' meant 'danger'. Your body is mobilizing energy to bridge the gap because it feels life-threatening.", interrupt: "Put the phone down. Walk into another room immediately. Push your hands hard against a wall for 10 seconds to discharge the adrenaline.", practice: "Self-Soothing: Place a hand on your chest and say 'I am here with you. I am not leaving you.' Repeat until your breathing slows.", anchor: "My safety is inside me, not in their response.", prompt: "What am I trying to earn from them right now that I can give to myself?" },
                es: { name: "Aferramiento Ansioso", subtype: "Activaci√≥n Modo Lucha", what: "Tu sistema nervioso est√° gritando. Sientes una necesidad urgente y fren√©tica de 'arreglar' la conexi√≥n inmediatamente. Esto no es amor; es una respuesta de lucha ante la amenaza de abandono.", why: "Se est√° tocando una herida de apego. Tu yo ni√±o aprendi√≥ que la 'distancia' significaba 'peligro'. Tu cuerpo est√° movilizando energ√≠a para cerrar la brecha porque se siente como una amenaza para la vida.", interrupt: "Baja el tel√©fono. Camina a otra habitaci√≥n inmediatamente. Empuja tus manos con fuerza contra una pared durante 10 segundos para descargar la adrenalina.", practice: "Autotranquilizaci√≥n: Coloca una mano en tu pecho y di 'Estoy aqu√≠ contigo. No te voy a dejar'. Repite hasta que tu respiraci√≥n se calme.", anchor: "Mi seguridad est√° dentro de m√≠, no en su respuesta.", prompt: "¬øQu√© estoy tratando de ganar de ellos ahora mismo que puedo darme a m√≠ mismo?" }
            },
            'shutdown': {
                en: { name: "Emotional Shutdown", subtype: "Freeze/Collapse Mode", what: "You are going numb. You feel foggy, distant, or 'checked out'. This is your system pulling the emergency brake to protect you from overwhelming pain.", why: "This is a learned survival strategy. When things got too heavy or scary in the past, your only option was to disappear inside yourself. You are not broken; you are protecting your core.", interrupt: "Shake your hands vigorously for 30 seconds. Wrap yourself tightly in a heavy blanket (burrito wrap). Stomp your feet on the ground 10 times.", practice: "Orientation: Name 3 colors you see in the room out loud. Then name 3 textures you can feel. Bring your brain back to the present moment.", anchor: "It is safe to be in my body. I am right here.", prompt: "What specific emotion am I numbing out to avoid feeling right now?" },
                es: { name: "Apagado Emocional", subtype: "Modo Congelaci√≥n/Colapso", what: "Te est√°s entumeciendo. Te sientes brumoso, distante o 'desconectado'. Este es tu sistema tirando del freno de emergencia para protegerte de un dolor abrumador.", why: "Esta es una estrategia de supervivencia aprendida. Cuando las cosas se pon√≠an demasiado pesadas o aterradoras en el pasado, tu √∫nica opci√≥n era desaparecer dentro de ti mismo. No est√°s roto; est√°s protegiendo tu n√∫cleo.", interrupt: "Sacude tus manos vigorosamente durante 30 segundos. Envu√©lvete apretadamente en una manta pesada. Golpea tus pies en el suelo 10 veces.", practice: "Orientaci√≥n: Nombra 3 colores que veas en la habitaci√≥n en voz alta. Luego nombra 3 texturas que puedas sentir. Trae tu cerebro de vuelta al momento presente.", anchor: "Es seguro estar en mi cuerpo. Estoy justo aqu√≠.", prompt: "¬øQu√© emoci√≥n espec√≠fica estoy adormeciendo para evitar sentir ahora mismo?" }
            },
            'over_explaining': {
                en: { name: "Over-Explaining", subtype: "Fawn/Appeasement Mode", what: "You are over-talking and over-giving to manage the other person's emotions. You believe if you explain yourself perfectly, you won't be rejected.", why: "You learned that your needs were 'too much' or unsafe. You survived by becoming easy, manageable, and 'good'. You are abandoning your truth to keep the peace.", interrupt: "Stop talking. Take a breath. Say: 'I've said enough.' Press your tongue to the roof of your mouth to stop the urge to speak.", practice: "The Pause: Count to 5 before responding to anything today. Allow silence to exist without filling it.", anchor: "I do not need to explain my existence to be worthy.", prompt: "Where am I shrinking myself to make someone else comfortable?" },
                es: { name: "Explicaci√≥n Excesiva", subtype: "Modo Complacencia", what: "Est√°s hablando y dando demasiado para gestionar las emociones de la otra persona. Crees que si te explicas perfectamente, no ser√°s rechazado.", why: "Aprendiste que tus necesidades eran 'demasiado' o inseguras. Sobreviviste volvi√©ndote f√°cil, manejable y 'bueno'. Est√°s abandonando tu verdad para mantener la paz.", interrupt: "Deja de hablar. Toma un respiro. Di: 'He dicho suficiente'. Presiona tu lengua contra el paladar para detener el impulso de hablar.", practice: "La Pausa: Cuenta hasta 5 antes de responder a cualquier cosa hoy. Permite que el silencio exista sin llenarlo.", anchor: "No necesito explicar mi existencia para ser digno.", prompt: "¬øD√≥nde me estoy encogiendo para hacer que alguien m√°s se sienta c√≥modo?" }
            },
            'over_giving': {
                en: { name: "Over Giving", subtype: "Fawn/Appeasement", what: "You are pouring out energy and resources to ensure you are 'needed.' You are preemptively paying a debt you don't owe.", why: "You learned that love was conditional on your utility. If you stop giving, you fear you will become disposable.", interrupt: "Clench your fists, then release. Ask yourself: 'Do I actually want to do this, or am I just afraid to say no?'", practice: "Say 'No' to one small thing today. It doesn't have to be big. Just reclaim one piece of your energy.", anchor: "My value is not in what I provide. I am enough.", prompt: "What am I trying to buy with my generosity?" },
                es: { name: "Dar en Exceso", subtype: "Modo Complacencia", what: "Est√°s vertiendo energ√≠a y recursos para asegurarte de ser 'necesitado'. Est√°s pagando preventivamente una deuda que no debes.", why: "Aprendiste que el amor estaba condicionado a tu utilidad. Si dejas de dar, temes volverte desechable.", interrupt: "Aprieta los pu√±os, luego suelta. Preg√∫ntate: '¬øRealmente quiero hacer esto, o solo tengo miedo de decir que no?'", practice: "Di 'No' a una cosa peque√±a hoy. No tiene que ser grande. Solo recupera un pedazo de tu energ√≠a.", anchor: "Mi valor no est√° en lo que proveo. Soy suficiente.", prompt: "¬øQu√© estoy tratando de comprar con mi generosidad?" }
            },
            'distrust': {
                en: { name: "Hyper-Vigilance", subtype: "Scan Mode", what: "You are waiting for the other shoe to drop. You are analyzing tone, timing, and words, looking for betrayal or rejection.", why: "Chaos feels familiar to you; stability feels suspicious. Your nervous system is wired to scan for danger because you weren't protected in the past.", interrupt: "Look around the room. Find 3 cues of safety (a locked door, a cozy chair). Fact-check: What is real vs. what is my fear imagining?", practice: "Reality Testing: Write down the facts in one column and your 'story' in the other. See the difference.", anchor: "I can trust myself to handle whatever happens.", prompt: "What story am I inventing to prepare myself for pain?" },
                es: { name: "Hipervigilancia", subtype: "Modo Escaneo", what: "Est√°s esperando que caiga el otro zapato. Est√°s analizando el tono, el tiempo y las palabras, buscando traici√≥n o rechazo.", why: "El caos te resulta familiar; la estabilidad te parece sospechosa. Tu sistema nervioso est√° conectado para escanear peligros porque no fuiste protegido en el pasado.", interrupt: "Mira alrededor de la habitaci√≥n. Encuentra 3 se√±ales de seguridad (una puerta cerrada, una silla c√≥moda). Verificaci√≥n de hechos: ¬øQu√© es real vs. qu√© est√° imaginando mi miedo?", practice: "Prueba de Realidad: Escribe los hechos en una columna y tu 'historia' en la otra. Mira la diferencia.", anchor: "Puedo confiar en m√≠ mismo para manejar lo que sea que suceda.", prompt: "¬øQu√© historia estoy inventando para prepararme para el dolor?" }
            },
            'self_blame': {
                en: { name: "Internalized Blame", subtype: "Shame Mode", what: "You are taking 100% of the responsibility for the disconnection. You are turning the anger inward on yourself.", why: "As a child, it was safer to believe 'I am bad' (which I can fix) than 'My caregiver is unsafe' (which is terrifying). You are blaming yourself to maintain a sense of control.", interrupt: "Say out loud: 'This is not all my fault.' Push your feet firmly into the floor. Release the tension in your stomach.", practice: "Compassion: Talk to yourself like you would talk to your best friend who made a mistake.", anchor: "I am not the problem. I am worthy of repair.", prompt: "What responsibility am I carrying that actually belongs to someone else?" },
                es: { name: "Culpa Internalizada", subtype: "Modo Verg√ºenza", what: "Est√°s asumiendo el 100% de la responsabilidad por la desconexi√≥n. Est√°s volviendo la ira hacia ti mismo.", why: "De ni√±o, era m√°s seguro creer 'Soy malo' (lo cual puedo arreglar) que 'Mi cuidador es inseguro' (lo cual es aterrador). Te est√°s culpando a ti mismo para mantener una sensaci√≥n de control.", interrupt: "Di en voz alta: 'Esto no es todo culpa m√≠a'. Empuja tus pies firmemente en el suelo. Libera la tensi√≥n en tu est√≥mago.", practice: "Compasi√≥n: H√°blate a ti mismo como le hablar√≠as a tu mejor amigo que cometi√≥ un error.", anchor: "No soy el problema. Soy digno de reparaci√≥n.", prompt: "¬øQu√© responsabilidad estoy cargando que en realidad pertenece a otra persona?" }
            }
        };

        // --- GLOBAL STATE ---
        let currentLang = 'en';
        let isPremium = localStorage.getItem('lunaPremium') === 'true';
        let consentGiven = localStorage.getItem('lunaConsent') === 'true';
        let vault = JSON.parse(localStorage.getItem('lunaVault') || '{"free":[],"premium":[]}');
        if (Array.isArray(vault)) { vault = { free: vault, premium: [] }; localStorage.setItem('lunaVault', JSON.stringify(vault)); }

        let currentInputs = { vent: "", intensity: 5, behavior: "" };
        let currentResult = null;
        let activeModule = null;
        let activeTab = 'free';

        // --- FUNCTIONS ---
        function navigateTo(id) {
            document.querySelectorAll('main > div, main > section').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            // Progress Bar Update
            const progress = { 'screen-home': '0%', 'screen-checkin': '33%', 'screen-result': '66%', 'screen-module': '100%' }[id];
            const bar = document.getElementById('progress-container');
            const fill = document.getElementById('progress-fill');
            if(progress && progress !== '0%') { bar.classList.remove('hidden'); setTimeout(() => fill.style.width = progress, 50); } else { bar.classList.add('hidden'); }
            if(id === 'screen-vault') renderVault();
        }

        function toggleLang() {
            currentLang = currentLang === 'en' ? 'es' : 'en';
            document.getElementById('lang-display').innerText = currentLang.toUpperCase();
            const t = LANG[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(t[key]) el.innerText = t[key];
            });
        }

        function runDecoder() {
            const b = document.getElementById('in-behavior').value;
            if(!b) return alert("Please select a behavior.");
            
            currentInputs.behavior = b;
            currentInputs.vent = document.getElementById('in-vent').value;
            currentInputs.intensity = document.getElementById('in-intensity').value;
            
            document.getElementById('decode-btn-text').innerText = "Analyzing...";
            document.getElementById('decode-spinner').classList.remove('hidden');
            
            setTimeout(() => {
                const db = LOGIC_DB[b] || LOGIC_DB['panic_clinging'];
                const data = db[currentLang];
                
                currentResult = { ...data, behavior: b };
                
                document.getElementById('out-pattern').innerText = data.name;
                document.getElementById('out-subtype').innerText = `${data.subtype} ‚Ä¢ ${currentInputs.intensity}/10`;
                document.getElementById('out-what').innerText = data.what;
                document.getElementById('out-why').innerText = data.why;
                
                document.getElementById('decode-btn-text').innerText = "Decode My Pattern";
                document.getElementById('decode-spinner').classList.add('hidden');
                navigateTo('screen-result');
            }, 600);
        }

        function showModule(type) {
            if(type === 'journal' && !isPremium) return showPaywall();
            activeModule = type;
            
            const r = currentResult;
            let content = "";
            if (type === "interrupt") content = r.interrupt;
            else if (type === "practice") content = r.practice;
            else if (type === "anchor") content = r.anchor;
            else if (type === "journal") content = r.prompt;
            
            document.getElementById('mod-title').innerText = type.toUpperCase();
            document.getElementById('mod-content').innerText = content;
            
            const jArea = document.getElementById('journal-area');
            if (type === 'journal') {
                jArea.classList.remove('hidden');
                document.getElementById('journal-input-module').value = currentInputs.vent ? `[Vent]: ${currentInputs.vent}\n\n` : "";
            } else { jArea.classList.add('hidden'); }
            
            navigateTo('screen-module');
        }

        function saveFreeEntry() {
            if(!consentGiven) return navigateTo('screen-safety');
            const entry = { id: Date.now(), date: new Date().toISOString(), inputs: { ...currentInputs }, result: currentResult };
            vault.free.unshift(entry);
            localStorage.setItem('lunaVault', JSON.stringify(vault));
            toast("Saved");
        }

        function saveModuleEntry() {
            if(!isPremium) return showPaywall();
            let content = document.getElementById('mod-content').innerText;
            if (activeModule === 'journal') content += "\n\n" + document.getElementById('journal-input-module').value;
            const entry = { id: Date.now(), date: new Date().toISOString(), text: content, type: activeModule };
            vault.premium.unshift(entry);
            localStorage.setItem('lunaVault', JSON.stringify(vault));
            toast("Saved");
        }

        function renderVault(tab = activeTab) {
            const list = document.getElementById('vault-content');
            const data = vault[tab];
            if (!data || data.length === 0) { list.innerHTML = '<p class="text-center text-gray-400 mt-10">Empty / Vac√≠o</p>'; return; }
            list.innerHTML = data.map(e => `<div class="bg-white p-4 rounded-xl shadow border-l-4 border-sage-500 mb-3 relative dark:bg-gray-800"><div class="flex justify-between mb-1"><span class="font-bold text-gray-800 dark:text-white">${e.result ? e.result.name : 'Journal'}</span><span class="text-xs text-gray-400">${new Date(e.date).toLocaleDateString()}</span></div><p class="text-sm text-gray-600 italic dark:text-gray-300">"${(e.inputs ? e.inputs.vent : e.text).substring(0, 60)}..."</p></div>`).join('');
        }

        function switchTab(tab) {
            activeTab = tab;
            document.getElementById('tab-free').className = tab === 'free' ? 'flex-1 py-2 text-xs font-bold rounded bg-sage-100 text-sage-700' : 'flex-1 py-2 text-xs font-bold rounded text-gray-400';
            document.getElementById('tab-premium').className = tab === 'premium' ? 'flex-1 py-2 text-xs font-bold rounded bg-sage-100 text-sage-700' : 'flex-1 py-2 text-xs font-bold rounded text-gray-400';
            renderVault(tab);
        }

        function toast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); }
        function showPaywall() { document.getElementById('paywallModal').classList.remove('hidden'); }
        function closePaywall() { document.getElementById('paywallModal').classList.add('hidden'); }
        function toggleModal(id) { const m = document.getElementById(id); m.classList.contains('hidden') ? m.classList.remove('hidden') : m.classList.add('hidden'); }
        function grantConsent() { consentGiven = true; localStorage.setItem('lunaConsent', 'true'); navigateTo('screen-intake'); }
        function startPremiumJournal() { if(!isPremium) return showPaywall(); navigateTo('screen-premium-journal'); }
        function startVoice(id) {
            if (!('webkitSpeechRecognition' in window)) return toast("Mic not supported");
            const recognition = new webkitSpeechRecognition();
            recognition.lang = currentLang === 'en' ? 'en-US' : 'es-ES';
            recognition.onstart = () => { toast("Listening..."); document.querySelector(`[onclick*="${id}"] i`).classList.add('mic-active'); };
            recognition.onend = () => document.querySelector(`[onclick*="${id}"] i`).classList.remove('mic-active');
            recognition.onresult = (event) => document.getElementById(id).value += " " + event.results[0][0].transcript;
            recognition.start();
        }
        function checkCode() {
            if (document.getElementById('accessCode').value.toUpperCase() === 'LUNA2025') {
                isPremium = true; localStorage.setItem('lunaPremium', 'true');
                alert("Unlocked!"); closePaywall(); 
                document.getElementById('upgradeBtn').classList.add('hidden');
            } else { alert("Incorrect Code"); }
        }

        if(isPremium) document.getElementById('upgradeBtn').classList.add('hidden');
        navigateTo('screen-home');
    </script>
</body>
</html>