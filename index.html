<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Somatic tool to decode abandonment patterns and regulate the nervous system.">
    <title>Pattern Breaker | LunaSoul</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÉ</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8A9A5B">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { sage: { 50: '#f4f7f4', 100: '#E8EDE6', 500: '#8A9A5B', 600: '#738249', 700: '#5F6F46', 900: '#2f3823' }, sand: '#F5F5F0' } } }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F5F5F0; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Toast & Mic Styles */
        #toast { visibility: hidden; min-width: 250px; transform: translateX(-50%); background-color: #2f3823; color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 100; left: 50%; bottom: 30px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        .mic-active { color: #ef4444 !important; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        
        /* Slider */
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #fff; border: 2px solid currentColor; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col mx-auto max-w-md bg-sand transition-colors duration-300 dark:bg-gray-900 dark:text-gray-100">

    <header class="w-full bg-sage-500 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-2 cursor-pointer" onclick="App.navigateTo('screen-home')" role="button" tabindex="0" aria-label="Go to Home">
            <h1 class="font-semibold text-lg tracking-wide">Pattern Breaker</h1>
        </div>
        <div class="flex gap-3 items-center">
             <button onclick="App.toggleLang()" class="text-xs font-bold border border-white px-2 py-1 rounded hover:bg-white hover:text-sage-500 transition" aria-label="Toggle Language">üåê <span id="lang-display">EN</span></button>
             <button id="upgradeBtn" onclick="UI.showPaywall()" class="bg-white text-sage-700 px-3 py-1 rounded text-xs font-bold shadow hidden">Upgrade</button>
             <button onclick="App.navigateTo('screen-settings')" class="hover:text-sage-200" aria-label="Settings"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div id="progress-container" class="w-full h-1.5 bg-gray-200 hidden" aria-hidden="true">
        <div id="progress-fill" class="h-1.5 bg-sage-500 w-0 transition-all duration-500"></div>
    </div>

    <main id="app-container" class="flex-grow p-4 pb-24 relative overflow-y-auto" aria-live="polite">

        <section id="screen-home" class="fade-in">
            <div class="text-center mt-8 mb-8">
                <div class="w-24 h-24 bg-sage-100 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-inner text-sage-600" aria-hidden="true">üçÉ</div>
                <h2 class="text-3xl font-bold text-sage-700 dark:text-sage-300" data-i18n="welcome_title">Welcome Home.</h2>
                <p class="text-gray-600 dark:text-gray-400 mt-4 text-sm leading-relaxed px-4" data-i18n="welcome_text">Decode your abandonment patterns, interrupt the spiral, and return to safety.</p>
            </div>
            
            <button onclick="App.navigateTo('screen-safety')" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-105 mb-4" data-i18n="btn_start">Start Check-In (Free)</button>

            <button onclick="App.startPremiumJournal()" class="w-full bg-white border-2 border-sage-500 text-sage-700 font-bold py-4 rounded-xl shadow-sm transition mb-4 flex justify-center items-center gap-2 dark:bg-gray-800 dark:border-sage-400 dark:text-sage-300">
                <i class="fas fa-pen-nib" aria-hidden="true"></i> <span data-i18n="btn_journal">Guided Journaling</span> <span id="lock-icon" class="text-xs ml-1">üîí</span>
            </button>

            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="App.navigateTo('screen-vault')" class="bg-white p-3 rounded-lg shadow text-sm font-semibold text-gray-700 dark:bg-gray-800 dark:text-gray-300"><i class="fas fa-book mr-2"></i><span data-i18n="btn_vault">Vault</span></button>
                <button onclick="UI.toggleModal('modal-about')" class="bg-white p-3 rounded-lg shadow text-sm font-semibold text-gray-700 dark:bg-gray-800 dark:text-gray-300"><i class="fas fa-info-circle mr-2"></i><span data-i18n="btn_about">About</span></button>
            </div>
            
            <div class="mt-6 text-center">
                <a href="https://angel-s-site-4148.thinkific.com/courses/understanding-relationship-patterns" target="_blank" class="text-xs text-sage-600 font-bold underline dark:text-sage-400" data-i18n="link_course">Take the Full Course</a>
            </div>
            <p class="text-center text-xs text-gray-300 mt-8">v23.0</p>
        </section>

        <section id="screen-safety" class="hidden fade-in pt-6">
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-sage-500 dark:bg-gray-800">
                <h2 class="text-xl font-bold text-gray-800 mb-4 dark:text-white" tabindex="-1" id="safety-heading"><i class="fas fa-heart text-sage-500 mr-2"></i><span data-i18n="safety_title">Emotional Safety</span></h2>
                <p class="text-sm text-gray-600 leading-relaxed mb-4 dark:text-gray-300" data-i18n="safety_text">This is a self-guided tool. It is not a substitute for therapy. Some prompts may bring up strong emotions ‚Äî please pause if you need to.</p>
                <div class="bg-sage-50 p-3 rounded-lg mb-6 dark:bg-gray-700">
                    <h3 class="text-xs font-bold text-sage-700 uppercase mb-1 dark:text-sage-300"><i class="fas fa-lock mr-1"></i> <span data-i18n="privacy_title">Privacy Notice</span></h3>
                    <p class="text-xs text-gray-600 dark:text-gray-400" data-i18n="privacy_text">Your journal entries are stored only on this device.</p>
                </div>
                <button onclick="App.grantConsent()" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-3 rounded-lg" data-i18n="btn_agree">I Understand & Proceed</button>
                <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-4 dark:text-sage-400" data-i18n="btn_back">Back</button>
            </div>
        </section>

        <section id="screen-intake" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-6 dark:text-sage-300" tabindex="-1" id="intake-heading" data-i18n="checkin_title">Check-In</h2>
            
            <div class="mb-6 relative">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2" data-i18n="label_vent">What's happening? (Vent here)</label>
                <textarea id="in-vent" rows="3" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-base outline-none shadow-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white"></textarea>
                <button onclick="App.startVoice('in-vent')" class="absolute bottom-3 right-3 text-gray-400 hover:text-sage-500" aria-label="Start Voice Input"><i class="fas fa-microphone"></i></button>
            </div>

            <div class="mb-8">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2" data-i18n="label_intensity">Intensity (1-10)</label>
                <input type="range" id="in-intensity" min="1" max="10" value="5" class="w-full" oninput="document.getElementById('intensity-val').innerText = this.value">
                <p class="text-center font-bold text-sage-600 mt-2 dark:text-sage-400"><span data-i18n="level">Level</span>: <span id="intensity-val">5</span></p>
            </div>

            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2" data-i18n="label_reaction">First Reaction?</label>
                <select id="in-behavior" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-sm outline-none shadow-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                    <option value="hyper_independence" data-i18n="opt_indep">Pulling away / Isolating</option>
                    <option value="panic_clinging" data-i18n="opt_cling">Clinging / Panic texting</option>
                    <option value="shutdown" data-i18n="opt_shut">Emotional shutdown / Numbness</option>
                    <option value="over_giving" data-i18n="opt_give">Over giving (Appeasement)</option>
                    <option value="over_explaining" data-i18n="opt_explain">Over explaining (Fawn)</option>
                    <option value="distrust" data-i18n="opt_distrust">Checking / Scanning (Hypervigilance)</option>
                    <option value="self_blame" data-i18n="opt_blame">Self-blame (Shame)</option>
                </select>
            </div>

            <button onclick="Decoder.run()" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-4 rounded-xl shadow-lg mt-4 flex justify-center items-center gap-2">
                <span id="decode-btn-text" data-i18n="btn_decode">Decode My Pattern</span>
                <i id="decode-spinner" class="fas fa-spinner fa-spin hidden"></i>
            </button>
            <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-4 dark:text-sage-400" data-i18n="btn_cancel">Cancel</button>
        </section>

        <section id="screen-result" class="hidden fade-in pb-10">
            <div class="bg-sage-100 p-6 rounded-xl mb-6 border-l-4 border-sage-500 shadow-sm dark:bg-gray-800 dark:border-sage-400">
                <p class="text-xs uppercase tracking-widest text-gray-500 mb-1 dark:text-gray-400" data-i18n="label_detected">Detected Pattern</p>
                <h2 id="out-pattern" class="text-2xl font-bold text-sage-800 mb-2 dark:text-white" tabindex="-1" id="result-heading">...</h2>
                <div class="flex items-center gap-2">
                    <span id="out-badge" class="bg-sage-200 text-sage-800 text-xs px-2 py-1 rounded font-bold">Intensity: 5</span>
                    <span id="out-history" class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold hidden">Recurring</span>
                </div>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm mb-6 dark:bg-gray-800">
                <h3 class="font-bold text-gray-800 text-sm mb-2 border-b pb-2 dark:text-gray-200" data-i18n="label_what">What's Happening</h3>
                <p id="out-what" class="text-sm text-gray-600 leading-relaxed mb-4 dark:text-gray-300">...</p>
                <h3 class="font-bold text-gray-800 text-sm mb-2 border-b pb-2 dark:text-gray-200" data-i18n="label_why">Why It Activates</h3>
                <p id="out-why" class="text-sm text-gray-600 leading-relaxed dark:text-gray-300">...</p>
            </div>

            <div class="grid grid-cols-1 gap-3 mb-6">
                <button onclick="App.showModule('interrupt')" class="p-4 bg-sage-500 text-white rounded-xl shadow font-bold text-left flex justify-between"><span data-i18n="btn_interrupt">Pattern Interrupter</span><i class="fas fa-bolt"></i></button>
                <button onclick="App.showModule('practice')" class="p-4 bg-white border border-sage-200 rounded-xl shadow text-left flex justify-between dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200"><span data-i18n="btn_practice">Daily Practice</span><i class="fas fa-leaf text-sage-500"></i></button>
                <button onclick="App.showModule('anchor')" class="p-4 bg-white border border-sage-200 rounded-xl shadow text-left flex justify-between dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200"><span data-i18n="btn_anchor">Anchor for Today</span><i class="fas fa-anchor text-sage-500"></i></button>
                <button onclick="App.showModule('journal')" class="p-4 bg-white border border-sage-200 rounded-xl shadow text-left flex justify-between dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200"><span data-i18n="btn_journal_prompt">Journal Prompt</span><i class="fas fa-pen text-sage-500"></i></button>
            </div>

            <div class="bg-white border-2 border-sage-100 p-4 rounded-xl mb-4 text-center dark:bg-gray-800 dark:border-gray-600">
                <h3 class="font-bold text-sage-700 mb-2 dark:text-sage-300">Ready to heal the root?</h3>
                <p class="text-xs text-gray-500 mb-3 dark:text-gray-400">The app manages the symptom. The course heals the wound.</p>
                <a href="https://angel-s-site-4148.thinkific.com/courses/understanding-relationship-patterns" target="_blank" class="block bg-sage-100 text-sage-700 py-2 rounded-lg font-bold text-sm hover:bg-sage-200">View Course</a>
            </div>

            <button onclick="Vault.saveFreeEntry()" class="w-full text-center text-sage-600 text-sm font-bold mb-4 dark:text-sage-400" data-i18n="btn_save_result">Save Result to Vault</button>
            <button onclick="App.reset()" class="w-full text-center text-gray-400 text-sm" data-i18n="btn_next_decode">Start Next Decode</button>
        </section>

        <section id="screen-module" class="hidden fade-in pt-6">
            <h2 id="mod-title" class="text-xl font-bold text-sage-700 mb-4 dark:text-sage-300" tabindex="-1">Module</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-sage-500 mb-6 dark:bg-gray-800">
                <p id="mod-content" class="text-lg font-medium text-gray-800 leading-relaxed dark:text-gray-200">...</p>
            </div>
            <div id="journal-area" class="hidden mb-4">
                <textarea id="journal-input-module" rows="10" class="w-full p-4 bg-white border border-sage-200 rounded-lg text-base focus:ring-2 focus:ring-sage-500 outline-none shadow-inner dark:bg-gray-800 dark:border-gray-600 dark:text-white"></textarea>
            </div>
            <button onclick="Vault.saveModuleEntry()" class="w-full bg-sage-500 text-white font-bold py-3 rounded-xl shadow-lg mb-3" data-i18n="btn_save_vault">Save to Vault</button>
            <button onclick="App.navigateTo('screen-result')" class="w-full text-sage-600 font-bold text-center dark:text-sage-400" data-i18n="btn_back">Back</button>
        </section>

        <section id="screen-premium-journal" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-4 dark:text-sage-300" data-i18n="btn_journal">Guided Journaling</h2>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Select a Prompt</label>
                <select id="prem-prompt" class="w-full p-3 bg-white border border-sage-200 rounded-xl text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                    <option>What emotion felt biggest today?</option>
                    <option>Where did you downplay your needs?</option>
                    <option>What pattern repeated itself today?</option>
                    <option>What is the story I am telling myself?</option>
                </select>
            </div>
            <div class="relative">
                <textarea id="prem-text" rows="10" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-base focus:ring-2 focus:ring-sage-500 outline-none mb-4 dark:bg-gray-800 dark:border-gray-600 dark:text-white"></textarea>
                <button onclick="App.startVoice('prem-text')" class="absolute bottom-6 right-3 text-gray-400 hover:text-sage-500"><i class="fas fa-microphone"></i></button>
            </div>
            <button onclick="Vault.savePremiumEntry()" class="w-full bg-sage-500 text-white font-bold py-3 rounded-xl shadow-lg" data-i18n="btn_analyze">Analyze & Save</button>
            <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-4 dark:text-sage-400" data-i18n="btn_cancel">Cancel</button>
        </section>

        <section id="screen-vault" class="hidden fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-sage-700 dark:text-sage-300" data-i18n="btn_vault">The Vault</h2>
                <button onclick="App.navigateTo('screen-home')" class="text-sm text-sage-600 font-bold dark:text-sage-400" data-i18n="btn_back">Back</button>
            </div>
            <div class="flex mb-4 bg-white rounded-lg p-1 shadow-sm dark:bg-gray-800">
                <button onclick="Vault.switchTab('free')" id="tab-free" class="flex-1 py-2 text-xs font-bold rounded bg-sage-100 text-sage-700">Check-Ins</button>
                <button onclick="Vault.switchTab('premium')" id="tab-premium" class="flex-1 py-2 text-xs font-bold rounded text-gray-400">Journal</button>
                <button onclick="Vault.switchTab('reports')" id="tab-reports" class="flex-1 py-2 text-xs font-bold rounded text-gray-400">Reports</button>
            </div>
            <div id="vault-content" class="space-y-3 pb-20"></div>
            <div id="report-actions" class="hidden mt-4">
                <button onclick="Weekly.generate()" class="w-full bg-sage-600 text-white font-bold py-3 rounded-xl shadow-lg mb-2">Generate Weekly Report</button>
            </div>
        </section>

        <section id="screen-settings" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-6 dark:text-sage-300" data-i18n="settings_title">Settings</h2>
            <div class="bg-white rounded-xl shadow divide-y divide-gray-100 dark:bg-gray-800 dark:divide-gray-700">
                <div class="p-4 flex justify-between items-center">
                    <span class="text-gray-700 dark:text-gray-200" data-i18n="dark_mode">Dark Mode</span>
                    <button onclick="UI.toggleDark()" class="text-sage-500 font-bold text-xs bg-gray-100 dark:bg-gray-900 px-3 py-1 rounded">Toggle</button>
                </div>
                <div class="p-4 flex justify-between items-center">
                    <span class="text-red-400" data-i18n="clear_data">Clear Data</span>
                    <button onclick="Vault.clear()" class="text-red-500 font-bold text-xs bg-red-50 px-3 py-1 rounded">Clear</button>
                </div>
            </div>
            <div class="mt-8 text-center border-t pt-6 dark:border-gray-700">
                 <p class="text-xs text-gray-400 mb-2">Version 23.0</p>
                 <a href="https://angel-s-site-4148.thinkific.com/courses/understanding-relationship-patterns" target="_blank" class="text-sage-600 font-bold text-sm dark:text-sage-400">Visit Course Page</a>
            </div>
            <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-6 dark:text-sage-400" data-i18n="btn_back">Back</button>
        </section>

        <div id="modal-about" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true">
            <div class="bg-white rounded-xl p-6 max-w-sm w-full relative dark:bg-gray-800">
                <h2 class="text-xl font-bold text-sage-700 mb-4 dark:text-sage-300">About Pattern Breaker</h2>
                <p class="text-sm text-gray-600 mb-4 dark:text-gray-300">This tool helps you identify emotional patterns connected to abandonment wounds and offers self-guided practices to interrupt them.</p>
                <div class="bg-sage-50 p-3 rounded mb-4 text-xs dark:bg-gray-700">
                    <p class="font-bold text-sage-700 mb-1 dark:text-sage-300">FREE</p>
                    <p class="mb-2 dark:text-gray-400">Vent, Decode, Save Check-ins.</p>
                    <p class="font-bold text-sage-700 mb-1 dark:text-sage-300">PREMIUM</p>
                    <p class="dark:text-gray-400">Guided Journaling, Emotional Analysis, Weekly Reports.</p>
                </div>
                <button onclick="UI.toggleModal('modal-about')" class="w-full bg-sage-500 text-white py-2 rounded-lg font-bold">Close</button>
            </div>
        </div>

        <div id="modal-report-view" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true">
            <div class="bg-white rounded-xl p-6 max-w-sm w-full max-h-[80vh] overflow-y-auto relative dark:bg-gray-800">
                <h2 class="text-xl font-bold text-sage-700 mb-4 dark:text-white">Weekly Report</h2>
                <div id="report-body" class="text-sm text-gray-700 space-y-3 dark:text-gray-300"></div>
                <button onclick="UI.toggleModal('modal-report-view')" class="w-full bg-sage-500 text-white py-2 rounded-lg font-bold mt-4">Close</button>
            </div>
        </div>

        <div id="paywallModal" class="fixed inset-0 bg-black bg-opacity-60 z-[70] hidden flex items-center justify-center p-4" role="dialog" aria-modal="true">
            <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center dark:bg-gray-800">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 dark:text-white">Unlock the Vault</h2>
                <p class="text-gray-600 mb-6 text-sm dark:text-gray-300">Save your entries and access journaling. Included for course students.</p>
                <a href="https://buy.stripe.com/4gM5kDfQX6uj2Ghb829fW00" target="_blank" class="block w-full bg-sage-500 text-white font-bold py-3 rounded-lg mb-4 hover:bg-sage-600">Subscribe for $5/mo</a>
                <div class="flex gap-2">
                    <input type="text" id="accessCode" placeholder="STUDENT CODE" class="flex-grow border border-gray-300 rounded p-2 text-sm uppercase dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <button onclick="App.checkCode()" class="bg-gray-800 text-white px-4 rounded text-sm">Unlock</button>
                </div>
                <button onclick="UI.closePaywall()" class="mt-4 text-xs text-gray-400 underline">Close</button>
            </div>
        </div>
        
        <div id="toast">Saved</div>

    </main>

    <script>
        // --- TRANSLATIONS ---
        const LANG = {
            en: {
                welcome_title: "Welcome Home.", welcome_text: "Decode your abandonment patterns.", btn_start: "Start Check-In (Free)", btn_journal: "Guided Journaling", btn_vault: "Vault", btn_about: "About", link_course: "Take the Full Course",
                safety_title: "Emotional Safety", safety_text: "This is a self-guided tool, not therapy.", privacy_title: "Privacy Notice", privacy_text: "Data stored on device only.", btn_agree: "I Understand & Proceed", btn_back: "Back",
                checkin_title: "Check-In", label_vent: "What's happening? (Vent here)", label_intensity: "Intensity (1-10)", level: "Level", label_reaction: "First Reaction?", btn_decode: "Decode My Pattern", btn_cancel: "Cancel",
                label_detected: "Detected Pattern", label_what: "What's Happening", label_why: "Why It Activates", btn_interrupt: "Interrupter", btn_practice: "Daily Practice", btn_anchor: "Anchor", btn_journal_prompt: "Journal Prompt", btn_save_result: "Save Result", btn_next_decode: "Start Next Decode",
                btn_save_vault: "Save to Vault", btn_analyze: "Analyze & Save", btn_vault: "The Vault", settings_title: "Settings", dark_mode: "Dark Mode", clear_data: "Clear Data",
                opt_indep: "Pulling away / Isolating", opt_cling: "Clinging / Panic texting", opt_shut: "Shutdown / Numb", opt_give: "Over-giving", opt_explain: "Over-explaining", opt_distrust: "Checking / Scanning", opt_blame: "Self-blame"
            },
            es: {
                welcome_title: "Bienvenido a Casa.", welcome_text: "Decodifica tus patrones de abandono.", btn_start: "Iniciar Chequeo (Gratis)", btn_journal: "Diario Guiado", btn_vault: "B√≥veda", btn_about: "Acerca de", link_course: "Tomar el Curso Completo",
                safety_title: "Seguridad Emocional", safety_text: "Herramienta de autoayuda, no terapia.", privacy_title: "Aviso de Privacidad", privacy_text: "Datos guardados solo en este dispositivo.", btn_agree: "Entiendo y Procedo", btn_back: "Atr√°s",
                checkin_title: "Chequeo", label_vent: "¬øQu√© est√° pasando? (Desah√≥gate aqu√≠)", label_intensity: "Intensidad (1-10)", level: "Nivel", label_reaction: "¬øPrimera Reacci√≥n?", btn_decode: "Decodificar Patr√≥n", btn_cancel: "Cancelar",
                label_detected: "Patr√≥n Detectado", label_what: "Lo que sucede", label_why: "Por qu√© se activa", btn_interrupt: "Interruptor", btn_practice: "Pr√°ctica Diaria", btn_anchor: "Ancla", btn_journal_prompt: "Pregunta de Diario", btn_save_result: "Guardar Resultado", btn_next_decode: "Comenzar Nuevo",
                btn_save_vault: "Guardar en B√≥veda", btn_analyze: "Analizar y Guardar", btn_vault: "La B√≥veda", settings_title: "Configuraci√≥n", dark_mode: "Modo Oscuro", clear_data: "Borrar Datos",
                opt_indep: "Alejarse / Aislarse", opt_cling: "Aferrarse / P√°nico", opt_shut: "Apagado / Entumecido", opt_give: "Dar en exceso", opt_explain: "Explicar en exceso", opt_distrust: "Verificar / Escanear", opt_blame: "Culparse a s√≠ mismo"
            }
        };

        // --- STATE ---
        const State = { lang: 'en', premium: localStorage.getItem('lunaPremium') === 'true', consent: localStorage.getItem('lunaConsent') === 'true', vault: JSON.parse(localStorage.getItem('lunaVault') || '{"free":[],"premium":[],"reports":[]}'), inputs: {}, currentResult: null, activeModule: null };
        if (Array.isArray(State.vault)) { State.vault = { free: State.vault, premium: [], reports: [] }; localStorage.setItem('lunaVault', JSON.stringify(State.vault)); }

        // --- LOGIC DB (INTELLIGENT) ---
        const LOGIC_DB = {
            'hyper_independence': {
                en: { name: "Hyper Independence", subtype: "Protection Mode", what: "You are pushing others away to maintain control. Your system registers 'needing' as 'unsafe'. You are fortifying your walls because vulnerability feels like a threat.", why: "This isn't about strength; it's a survival strategy. Early on, you likely learned that no one was coming to save you, so you decided to become your own savior. Your nervous system imprinted 'aloneness' as the only safety.", interrupt: "Drop your shoulders. Unclench your jaw.", practice: "The 5% Rule: Ask for help with one tiny thing today.", anchor: "I do not have to carry it all to be safe.", prompt: "What am I afraid will happen if I admit I need support right now?" },
                es: { name: "Hiperindependencia", subtype: "Modo Protecci√≥n", what: "Est√°s alejando a los dem√°s para mantener el control...", why: "Aprendiste que nadie vendr√≠a a salvarte...", interrupt: "Baja los hombros.", practice: "Pide ayuda con algo peque√±o.", anchor: "No tengo que cargar todo solo.", prompt: "¬øQu√© temo que pase si admito que necesito apoyo?" }
            },
            'panic_clinging': {
                en: { name: "Anxious Grasping", subtype: "Fight Mode", what: "System screaming. Need to fix.", why: "Attachment wound touched.", interrupt: "Phone down.", practice: "Hand on chest.", anchor: "Safety inside me.", prompt: "What am I trying to earn?" },
                es: { name: "Aferramiento Ansioso", subtype: "Modo Lucha", what: "Tu sistema grita. Necesitas arreglarlo.", why: "Herida de apego tocada.", interrupt: "Baja el tel√©fono.", practice: "Mano en el pecho.", anchor: "La seguridad est√° en m√≠.", prompt: "¬øQu√© estoy tratando de ganar?" }
            },
            'shutdown': {
                en: { name: "Emotional Shutdown", subtype: "Freeze Mode", what: "Going numb. Foggy.", why: "Learned disappearance.", interrupt: "Shake hands.", practice: "Name 3 colors.", anchor: "Safe in body.", prompt: "What feeling am I numbing?" },
                es: { name: "Apagado Emocional", subtype: "Modo Congelaci√≥n", what: "Te sientes entumecido.", why: "Aprendiste a desaparecer.", interrupt: "Sacude las manos.", practice: "Nombra 3 colores.", anchor: "Seguro en mi cuerpo.", prompt: "¬øQu√© emoci√≥n estoy adormeciendo?" }
            },
            'over_explaining': {
                en: { name: "Over-Explaining", subtype: "Fawn Mode", what: "Over-talking to manage emotion.", why: "Needs were 'too much'.", interrupt: "Stop talking.", practice: "Count to 5.", anchor: "No need to explain.", prompt: "Where am I shrinking?" },
                es: { name: "Explicaci√≥n Excesiva", subtype: "Modo Complacencia", what: "Hablas demasiado para gestionar emociones.", why: "Tus necesidades eran 'demasiado'.", interrupt: "Deja de hablar.", practice: "Cuenta hasta 5.", anchor: "No necesito explicar mi existencia.", prompt: "¬øD√≥nde me estoy encogiendo?" }
            },
            'over_giving': {
                en: { name: "Over Giving", subtype: "Fawn Mode", what: "Pouring out energy.", why: "Love conditional on utility.", interrupt: "Clench fists.", practice: "Say No.", anchor: "Value not in provision.", prompt: "What am I trying to buy?" },
                es: { "name": "Dar en Exceso", subtype: "Modo Complacencia", what: "Dando demasiada energ√≠a.", why: "Amor condicional.", interrupt: "Aprieta los pu√±os.", practice: "Di No.", anchor: "Mi valor no est√° en lo que doy.", prompt: "¬øQu√© estoy tratando de comprar?" }
            },
            'distrust': {
                en: { name: "Hyper-Vigilance", subtype: "Scan Mode", what: "Waiting for other shoe.", why: "Chaos familiar.", interrupt: "Look for safety.", practice: "Fact check.", anchor: "I can trust myself.", prompt: "What story am I inventing?" },
                es: { name: "Hipervigilancia", subtype: "Modo Escaneo", what: "Esperando lo peor.", why: "El caos es familiar.", interrupt: "Busca seguridad.", practice: "Verifica hechos.", anchor: "Puedo confiar en m√≠.", prompt: "¬øQu√© historia estoy inventando?" }
            },
            'self_blame': {
                en: { name: "Internalized Blame", subtype: "Shame Mode", what: "Taking 100% responsibility.", why: "Better bad than unsafe.", interrupt: "Push feet into floor.", practice: "Compassion.", anchor: "I am not problem.", prompt: "What responsibility isn't mine?" },
                es: { name: "Culpa Internalizada", subtype: "Modo Verg√ºenza", what: "Tomas 100% responsabilidad.", why: "Mejor ser malo que inseguro.", interrupt: "Empuja los pies al suelo.", practice: "Compasi√≥n.", anchor: "No soy el problema.", prompt: "¬øQu√© responsabilidad no es m√≠a?" }
            }
        };

        const EMOTION_KEYWORDS = { "anxious": ["worry", "scared", "nervous"], "angry": ["mad", "resent", "furious"], "sad": ["cry", "hopeless", "heavy"] };

        // --- APP LOGIC ---
        const App = {
            navigateTo(id) {
                document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                const fill = document.getElementById('progress-fill');
                const bar = document.getElementById('progress-container');
                const progress = { 'screen-home': '0%', 'screen-checkin': '33%', 'screen-result': '66%', 'screen-module': '100%' }[id];
                if (progress && progress !== '0%') { bar.classList.remove('hidden'); setTimeout(() => fill.style.width = progress, 50); } else { bar.classList.add('hidden'); }
                
                // Accessibility Focus
                const header = document.getElementById(id).querySelector('h2');
                if(header) header.focus();

                if(id === 'screen-vault') Vault.render('free');
            },
            toggleLang() {
                State.lang = State.lang === 'en' ? 'es' : 'en';
                document.getElementById('lang-display').innerText = State.lang.toUpperCase();
                App.translateUI();
            },
            translateUI() {
                const t = LANG[State.lang];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (t[key]) el.innerText = t[key];
                });
            },
            startCheckIn() { App.navigateTo('screen-intake'); },
            startPremiumJournal() { if(!State.premium) return UI.showPaywall(); App.navigateTo('screen-premium-journal'); },
            grantConsent() { State.consent = true; localStorage.setItem('lunaConsent', 'true'); App.navigateTo('screen-intake'); },
            startVoice(id) {
                if (!('webkitSpeechRecognition' in window)) return UI.toast("Mic not supported");
                const recognition = new webkitSpeechRecognition();
                recognition.lang = State.lang === 'en' ? 'en-US' : 'es-ES';
                recognition.onstart = () => { UI.toast(State.lang === 'en' ? "Listening..." : "Escuchando..."); document.querySelector(`[onclick*="${id}"] i`).classList.add('mic-active'); };
                recognition.onend = () => document.querySelector(`[onclick*="${id}"] i`).classList.remove('mic-active');
                recognition.onresult = (event) => document.getElementById(id).value += " " + event.results[0][0].transcript;
                recognition.start();
            },
            checkCode() {
                if (document.getElementById('accessCode').value.toUpperCase() === 'LUNA2025') {
                    State.premium = true; localStorage.setItem('lunaPremium', 'true');
                    alert(State.lang === 'en' ? "Unlocked!" : "¬°Desbloqueado!"); UI.closePaywall(); 
                    document.getElementById('upgradeBtn').classList.add('hidden');
                } else { alert("Incorrect Code"); }
            },
            showModule(type) {
                if(type === 'journal' && !State.premium) return UI.showPaywall();
                activeModule = type;
                
                const r = currentResult;
                let content = "";
                if (type === "interrupt") content = r.interrupt;
                else if (type === "practice") content = r.practice;
                else if (type === "anchor") content = r.anchor;
                else if (type === "journal") content = r.prompt;
                
                document.getElementById('mod-title').innerText = type.toUpperCase();
                document.getElementById('mod-content').innerText = content;
                
                const jArea = document.getElementById('journal-area');
                if (type === 'journal') {
                    jArea.classList.remove('hidden');
                    document.getElementById('journal-input-module').value = currentInputs.vent ? `[Vent]: ${currentInputs.vent}\n\n` : "";
                } else { jArea.classList.add('hidden'); }
                
                App.navigateTo('screen-module');
            }
        };

        const Decoder = {
            run() {
                try {
                    const b = document.getElementById('in-behavior').value;
                    currentInputs.behavior = b;
                    currentInputs.vent = document.getElementById('in-vent').value;
                    currentInputs.intensity = document.getElementById('in-intensity').value;
                    
                    document.getElementById('decode-btn-text').innerText = "Analyzing...";
                    
                    setTimeout(() => {
                        const db = LOGIC_DB[b] || LOGIC_DB['panic_clinging'];
                        const data = db[State.lang];
                        
                        currentResult = { ...data, behavior: b };
                        
                        // Intelligent Context Injection
                        // If user has multiple recent entries of same pattern, modify output text
                        const history = State.vault.free.filter(e => e.result && e.result.name === data.name);
                        if(history.length > 2) {
                            document.getElementById('out-history').classList.remove('hidden');
                        }

                        UI.setText('out-pattern', data.name);
                        UI.setText('out-subtype', `${data.subtype} ‚Ä¢ ${currentInputs.intensity}/10`);
                        UI.setText('out-what', data.what);
                        UI.setText('out-why', data.why);
                        
                        document.getElementById('decode-btn-text').innerText = "Decode";
                        App.navigateTo('screen-result');
                    }, 600);
                } catch (e) { alert("Error: " + e.message); }
            }
        };

        const Vault = {
            saveFreeEntry() {
                if(!State.consent) return App.navigateTo('screen-safety');
                const entry = { id: Date.now(), date: new Date().toISOString(), inputs: { ...currentInputs }, result: currentResult };
                State.vault.free.unshift(entry);
                localStorage.setItem('lunaVault', JSON.stringify(State.vault));
                UI.toast(State.lang === 'en' ? "Saved" : "Guardado");
            },
            saveModuleEntry() {
                if(!State.premium) return UI.showPaywall();
                let content = document.getElementById('mod-content').innerText;
                if (activeModule === 'journal') content += "\n\n" + document.getElementById('journal-input-module').value;
                const entry = { id: Date.now(), date: new Date().toISOString(), text: content, type: activeModule };
                State.vault.premium.unshift(entry);
                localStorage.setItem('lunaVault', JSON.stringify(State.vault));
                UI.toast("Saved");
            },
            savePremiumEntry() {
                const text = document.getElementById('prem-text').value;
                if (!text) return alert("Please write something.");
                const analysis = Analyzer.analyze(text);
                const entry = { id: Date.now(), date: new Date().toISOString(), prompt: document.getElementById('prem-prompt').value, text: text, analysis: analysis };
                State.vault.premium.unshift(entry);
                localStorage.setItem('lunaVault', JSON.stringify(State.vault));
                UI.toast("Analyzed & Saved");
                App.navigateTo('screen-home');
            },
            switchTab(tab) {
                activeTab = tab;
                document.getElementById('tab-free').className = tab === 'free' ? 'flex-1 py-2 text-xs font-bold rounded bg-sage-100 text-sage-700' : 'flex-1 py-2 text-xs font-bold rounded text-gray-400';
                document.getElementById('tab-premium').className = tab === 'premium' ? 'flex-1 py-2 text-xs font-bold rounded bg-sage-100 text-sage-700' : 'flex-1 py-2 text-xs font-bold rounded text-gray-400';
                document.getElementById('tab-reports').className = tab === 'reports' ? 'flex-1 py-2 text-xs font-bold rounded bg-sage-100 text-sage-700' : 'flex-1 py-2 text-xs font-bold rounded text-gray-400';
                
                const repBtn = document.getElementById('report-actions');
                if(tab === 'reports') repBtn.classList.remove('hidden'); else repBtn.classList.add('hidden');

                Vault.render(tab);
            },
            render(tab) {
                const list = document.getElementById('vault-content');
                const data = State.vault[tab];
                if (!data || data.length === 0) { list.innerHTML = '<p class="text-center text-gray-400 mt-10">Empty / Vac√≠o</p>'; return; }
                list.innerHTML = data.map(e => {
                    const date = new Date(e.date).toLocaleDateString();
                    if (tab === 'free') {
                         return `<div class="bg-white p-4 rounded-xl shadow border-l-4 border-sage-500 mb-3 relative dark:bg-gray-800"><div class="flex justify-between mb-1"><span class="font-bold text-gray-800 dark:text-white">${e.result.name}</span><span class="text-xs text-gray-400">${date}</span></div><p class="text-sm text-gray-600 italic dark:text-gray-300">"${(e.inputs.vent || '').substring(0, 60)}..."</p></div>`;
                    } else if (tab === 'premium') {
                         return `<div class="bg-white p-4 rounded-xl shadow border-l-4 border-purple-500 relative mb-3 dark:bg-gray-800"><div class="flex justify-between mb-1"><span class="font-bold text-gray-800 dark:text-white">Journal</span><span class="text-xs text-gray-400">${date}</span></div><p class="text-xs text-purple-600 font-bold mb-2">Tone: ${e.analysis.tone}</p><p class="text-sm text-gray-600 italic dark:text-gray-300">"${e.text.substring(0, 60)}..."</p></div>`;
                    } else {
                         return `<div class="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500 mb-3 dark:bg-gray-800"><p class="text-sm mt-2 dark:text-gray-300">${e.summary}</p></div>`;
                    }
                }).join('');
            },
            clear() { if(confirm("Delete? / ¬øBorrar?")) { localStorage.removeItem('lunaVault'); location.reload(); } }
        };

        const Weekly = {
            generate() {
                const entries = State.vault.premium;
                if (entries.length === 0) return alert("No Premium entries found.");
                const report = { id: Date.now(), date: new Date().toISOString(), summary: `You checked in ${entries.length} times this week. Keep going.` };
                State.vault.reports.unshift(report);
                localStorage.setItem('lunaVault', JSON.stringify(State.vault));
                UI.setText('report-body', report.summary);
                UI.toggleModal('modal-report-view');
                Vault.render('reports');
            }
        };

        const UI = {
            setText(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; },
            toast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); },
            showPaywall() { document.getElementById('paywallModal').classList.remove('hidden'); },
            closePaywall() { document.getElementById('paywallModal').classList.add('hidden'); },
            toggleModal(id) { const m = document.getElementById(id); m.classList.contains('hidden') ? m.classList.remove('hidden') : m.classList.add('hidden'); },
            toggleDark() { document.documentElement.classList.toggle('dark'); }
        };

        // Init
        if(State.premium) document.getElementById('upgradeBtn').classList.add('hidden');
        App.navigateTo('screen-home');
    </script>
</body>
</html>