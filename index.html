<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script>

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>Pattern Breaker | LunaSoul</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÉ</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8A9A5B">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
        window.onerror = function(msg, url, line) { alert("System Error: " + msg); return false; };
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { sage: { 50: '#f4f7f4', 100: '#E8EDE6', 500: '#8A9A5B', 600: '#738249', 700: '#5F6F46', 900: '#2f3823' }, sand: '#F5F5F0' } } } }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F5F5F0; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #toast { visibility: hidden; min-width: 250px; transform: translateX(-50%); background-color: #2f3823; color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 100; left: 50%; bottom: 30px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #fff; border: 2px solid currentColor; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .mic-active { color: #ef4444 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col mx-auto max-w-md bg-sand transition-colors duration-300 dark:bg-gray-900 dark:text-gray-100">

    <nav class="w-full bg-sage-500 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-2 cursor-pointer" onclick="App.navigateTo('screen-home')">
            <h1 class="font-semibold text-lg tracking-wide">Pattern Breaker</h1>
        </div>
        <div class="flex gap-3 items-center">
             <button onclick="App.toggleLang()" class="text-xs font-bold border border-white px-2 py-1 rounded hover:bg-white hover:text-sage-500 transition">üåê <span id="lang-display">EN</span></button>
             <button onclick="App.navigateTo('screen-settings')" class="hover:text-sage-200"><i class="fas fa-cog"></i></button>
        </div>
    </nav>

    <div id="progress-container" class="w-full h-1.5 bg-gray-200 hidden"><div id="progress-fill" class="h-1.5 bg-sage-500 w-0 transition-all duration-500"></div></div>

    <main id="app-container" class="flex-grow p-4 pb-24 relative overflow-y-auto">

        <div id="screen-home" class="fade-in">
            <div class="text-center mt-8 mb-8">
                <div class="w-24 h-24 bg-sage-100 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-inner text-sage-600">üçÉ</div>
                <h2 class="text-3xl font-bold text-sage-700 dark:text-sage-300" data-i18n="welcome_title">Welcome Home.</h2>
                <p class="text-gray-600 dark:text-gray-400 mt-4 text-sm leading-relaxed px-4" data-i18n="welcome_text">Decode your abandonment patterns, interrupt the spiral, and return to safety.</p>
            </div>
            <button onclick="App.navigateTo('screen-safety')" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-105 mb-4" data-i18n="btn_start">Start Check-In (Free)</button>
            <button onclick="App.startPremiumJournal()" class="w-full bg-white border-2 border-sage-500 text-sage-700 font-bold py-4 rounded-xl shadow-sm transition mb-4 flex justify-center items-center gap-2 dark:bg-gray-800 dark:border-sage-400 dark:text-sage-300">
                <i class="fas fa-pen-nib"></i> <span data-i18n="btn_journal">Guided Journaling</span> <span id="lock-icon" class="text-xs ml-1">üîí</span>
            </button>
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="App.navigateTo('screen-vault')" class="bg-white p-3 rounded-lg shadow text-sm font-semibold text-gray-700 dark:bg-gray-800 dark:text-gray-300"><i class="fas fa-book mr-2"></i><span data-i18n="btn_vault">Vault</span></button>
                <button onclick="UI.toggleModal('modal-about')" class="bg-white p-3 rounded-lg shadow text-sm font-semibold text-gray-700 dark:bg-gray-800 dark:text-gray-300"><i class="fas fa-info-circle mr-2"></i><span data-i18n="btn_about">About</span></button>
            </div>
            <div class="mt-6 text-center">
                <a href="https://angel-s-site-4148.thinkific.com/courses/understanding-relationship-patterns" target="_blank" class="text-xs text-sage-600 font-bold underline dark:text-sage-400" data-i18n="link_course">Take the Full Course</a>
            </div>
            <p class="text-center text-xs text-gray-300 mt-8">v32.0</p>
        </div>

        <div id="screen-safety" class="hidden fade-in pt-6">
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-sage-500 dark:bg-gray-800">
                <h2 class="text-xl font-bold text-gray-800 mb-4 dark:text-white"><i class="fas fa-heart text-sage-500 mr-2"></i><span data-i18n="safety_title">Emotional Safety</span></h2>
                <p class="text-sm text-gray-600 leading-relaxed mb-4 dark:text-gray-300" data-i18n="safety_text">This is a self-guided tool. It is not a substitute for therapy. If you feel unsafe, please contact a professional.</p>
                <button onclick="App.grantConsent()" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-3 rounded-lg" data-i18n="btn_agree">I Understand & Proceed</button>
                <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-4 dark:text-sage-400" data-i18n="btn_back">Back</button>
            </div>
        </div>

        <div id="screen-intake" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-6 dark:text-sage-300" data-i18n="checkin_title">Check-In</h2>
            <div class="mb-6 relative">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2" data-i18n="label_vent">What's happening? (Vent here)</label>
                <textarea id="in-vent" rows="3" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-base outline-none shadow-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white"></textarea>
                <button onclick="App.startVoice('in-vent')" class="absolute bottom-3 right-3 text-gray-400 hover:text-sage-500"><i class="fas fa-microphone"></i></button>
            </div>
            <div class="mb-8">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2" data-i18n="label_intensity">Intensity (1-10)</label>
                <input type="range" id="in-intensity" min="1" max="10" value="5" class="w-full" oninput="document.getElementById('intensity-val').innerText = this.value">
                <p class="text-center font-bold text-sage-600 mt-2 dark:text-sage-400"><span data-i18n="level">Level</span>: <span id="intensity-val">5</span></p>
            </div>
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2" data-i18n="label_reaction">First Reaction?</label>
                <select id="in-behavior" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-sm outline-none shadow-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                    <option value="hyper_independence" data-i18n="opt_indep">Pulling away / Isolating</option>
                    <option value="panic_clinging" data-i18n="opt_cling">Clinging / Panic texting</option>
                    <option value="shutdown" data-i18n="opt_shut">Emotional shutdown / Numbness</option>
                    <option value="over_giving" data-i18n="opt_give">Over giving (Appeasement)</option>
                    <option value="over_explaining" data-i18n="opt_explain">Over explaining (Fawn)</option>
                    <option value="distrust" data-i18n="opt_distrust">Checking / Scanning (Hypervigilance)</option>
                    <option value="self_blame" data-i18n="opt_blame">Self-blame (Shame)</option>
                </select>
            </div>
            <button onclick="App.runDecoder()" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-4 rounded-xl shadow-lg mt-4 flex justify-center items-center gap-2">
                <span id="decode-btn-text" data-i18n="btn_decode">Decode My Pattern</span>
                <i id="decode-spinner" class="fas fa-spinner fa-spin hidden"></i>
            </button>
            <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-4 dark:text-sage-400" data-i18n="btn_cancel">Cancel</button>
        </div>

        <div id="screen-result" class="hidden fade-in pb-10">
            <div class="bg-sage-100 p-6 rounded-xl mb-6 border-l-4 border-sage-500 shadow-sm dark:bg-gray-800 dark:border-sage-400">
                <p class="text-xs uppercase tracking-widest text-gray-500 mb-1 dark:text-gray-400" data-i18n="label_detected">Core Wound Detected</p>
                <h2 id="out-pattern" class="text-2xl font-bold text-sage-800 mb-2 dark:text-white">...</h2>
                <div class="flex items-center gap-2">
                    <span id="out-badge" class="bg-sage-200 text-sage-800 text-xs px-2 py-1 rounded font-bold">Intensity: 5</span>
                </div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm mb-6 dark:bg-gray-800">
                <h3 class="font-bold text-gray-800 text-sm mb-2 border-b pb-2 dark:text-gray-200" data-i18n="label_what">The Somatic Reality</h3>
                <p id="out-what" class="text-sm text-gray-600 leading-relaxed mb-4 dark:text-gray-300">...</p>
                <h3 class="font-bold text-gray-800 text-sm mb-2 border-b pb-2 dark:text-gray-200" data-i18n="label_why">Origin Story</h3>
                <p id="out-why" class="text-sm text-gray-600 leading-relaxed dark:text-gray-300">...</p>
            </div>
            <div class="grid grid-cols-1 gap-3 mb-6">
                <button onclick="App.showModule('interrupt')" class="p-4 bg-sage-500 text-white rounded-xl shadow font-bold text-left flex justify-between"><span data-i18n="btn_interrupt">Somatic Interrupter</span><i class="fas fa-bolt"></i></button>
                <button onclick="App.showModule('practice')" class="p-4 bg-white border border-sage-200 rounded-xl shadow text-left flex justify-between dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200"><span data-i18n="btn_practice">Micro-Practice</span><i class="fas fa-leaf text-sage-500"></i></button>
                <button onclick="App.showModule('anchor')" class="p-4 bg-white border border-sage-200 rounded-xl shadow text-left flex justify-between dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200"><span data-i18n="btn_anchor">Truth Anchor</span><i class="fas fa-anchor text-sage-500"></i></button>
                <button onclick="App.showModule('journal')" class="p-4 bg-white border border-sage-200 rounded-xl shadow text-left flex justify-between dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200"><span data-i18n="btn_journal_prompt">Deep Inquiry</span><i class="fas fa-pen text-sage-500"></i></button>
            </div>
            <button onclick="App.saveFreeEntry()" class="w-full text-center text-sage-600 text-sm font-bold mb-4 dark:text-sage-400" data-i18n="btn_save_result">Save Result</button>
            <button onclick="App.reset()" class="w-full text-center text-gray-400 text-sm" data-i18n="btn_next_decode">Start Next Decode</button>
        </div>

        <div id="screen-module" class="hidden fade-in pt-6">
            <h2 id="mod-title" class="text-xl font-bold text-sage-700 mb-4 dark:text-sage-300">Module</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-sage-500 mb-6 dark:bg-gray-800">
                <p id="mod-content" class="text-lg font-medium text-gray-800 leading-relaxed dark:text-gray-200">...</p>
            </div>
            <div id="journal-area" class="hidden mb-4">
                <textarea id="journal-input-module" rows="10" class="w-full p-4 bg-white border border-sage-200 rounded-lg text-base focus:ring-2 focus:ring-sage-500 outline-none shadow-inner dark:bg-gray-800 dark:border-gray-600 dark:text-white"></textarea>
            </div>
            <button onclick="App.saveModuleEntry()" class="w-full bg-sage-500 text-white font-bold py-3 rounded-xl shadow-lg mb-3" data-i18n="btn_save_vault">Save to Vault</button>
            <button onclick="App.navigateTo('screen-result')" class="w-full text-sage-600 font-bold text-center dark:text-sage-400" data-i18n="btn_back">Back</button>
        </div>

        <div id="screen-premium-journal" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-4 dark:text-sage-300" data-i18n="btn_journal">Guided Journaling</h2>
            <textarea id="prem-text" rows="10" class="w-full p-4 bg-white border border-sage-200 rounded-xl text-base focus:ring-2 focus:ring-sage-500 outline-none mb-4 dark:bg-gray-800 dark:border-gray-600 dark:text-white"></textarea>
            <button onclick="App.startVoice('prem-text')" class="block mb-4 text-gray-400 hover:text-sage-500"><i class="fas fa-microphone"></i></button>
            <button onclick="App.savePremiumEntry()" class="w-full bg-sage-500 text-white font-bold py-3 rounded-xl shadow-lg" data-i18n="btn_analyze">Analyze & Save</button>
            <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-4 dark:text-sage-400" data-i18n="btn_cancel">Cancel</button>
        </div>

        <div id="screen-vault" class="hidden fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-sage-700 dark:text-sage-300" data-i18n="btn_vault">The Vault</h2>
                <button onclick="App.navigateTo('screen-home')" class="text-sm text-sage-600 font-bold dark:text-sage-400" data-i18n="btn_back">Back</button>
            </div>
            <div class="flex mb-4 bg-white rounded-lg p-1 shadow-sm dark:bg-gray-800">
                <button onclick="App.switchTab('free')" id="tab-free" class="flex-1 py-2 text-xs font-bold rounded bg-sage-100 text-sage-700">Check-Ins</button>
                <button onclick="App.switchTab('premium')" id="tab-premium" class="flex-1 py-2 text-xs font-bold rounded text-gray-400">Journal</button>
            </div>
            <div id="vault-content" class="space-y-3 pb-20"></div>
        </div>

        <div id="screen-settings" class="hidden fade-in">
            <h2 class="text-xl font-bold text-sage-700 mb-6 dark:text-sage-300" data-i18n="settings_title">Settings</h2>
            <div class="bg-white rounded-xl shadow divide-y divide-gray-100 dark:bg-gray-800 dark:divide-gray-700">
                <div class="p-4 flex justify-between items-center">
                    <span class="text-gray-700 dark:text-gray-200" data-i18n="dark_mode">Dark Mode</span>
                    <button onclick="App.toggleDark()" class="text-sage-500 font-bold text-xs bg-gray-100 dark:bg-gray-900 px-3 py-1 rounded">Toggle</button>
                </div>
                <div class="p-4 flex justify-between items-center">
                    <span class="text-red-400" data-i18n="clear_data">Clear Data</span>
                    <button onclick="App.clearVault()" class="text-red-500 font-bold text-xs bg-red-50 px-3 py-1 rounded">Clear</button>
                </div>
            </div>
            <button onclick="App.navigateTo('screen-home')" class="w-full text-center text-sage-600 font-bold mt-6 dark:text-sage-400" data-i18n="btn_back">Back</button>
        </div>

        <div id="modal-about" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl p-6 max-w-sm w-full relative dark:bg-gray-800">
                <h2 class="text-xl font-bold text-sage-700 mb-4 dark:text-sage-300">About Pattern Breaker</h2>
                <p class="text-sm text-gray-600 mb-4 dark:text-gray-300">This tool helps you identify emotional patterns connected to abandonment wounds and offers self-guided practices to interrupt them.</p>
                <button onclick="UI.toggleModal('modal-about')" class="w-full bg-sage-500 text-white py-2 rounded-lg font-bold">Close</button>
            </div>
        </div>
        <div id="paywallModal" class="fixed inset-0 bg-black bg-opacity-60 z-[70] hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center dark:bg-gray-800">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 dark:text-white">Unlock Premium</h2>
                <a href="https://buy.stripe.com/4gM5kDfQX6uj2Ghb829fW00" target="_blank" class="block w-full bg-sage-500 text-white font-bold py-3 rounded-lg mb-4 hover:bg-sage-600">Subscribe</a>
                <div class="flex gap-2">
                    <input type="text" id="accessCode" placeholder="CODE" class="flex-grow border border-gray-300 rounded p-2 text-sm uppercase dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <button onclick="App.checkCode()" class="bg-gray-800 text-white px-4 rounded text-sm">Unlock</button>
                </div>
                <button onclick="UI.closePaywall()" class="mt-4 text-xs text-gray-400 underline">Close</button>
            </div>
        </div>
        <div id="toast">Saved</div>
    </main>

    <script>
        // --- TRANSLATIONS (EN/ES) ---
        const LANG = {
            en: {
                welcome_title: "Welcome Home.", welcome_text: "Decode your abandonment patterns.", btn_start: "Start Check-In (Free)", btn_journal: "Guided Journaling", btn_vault: "Vault", btn_about: "About", link_course: "Take the Full Course",
                safety_title: "Emotional Safety", safety_text: "This is a self-guided tool, not therapy.", privacy_title: "Privacy Notice", privacy_text: "Data stored on device only.", btn_agree: "I Understand & Proceed", btn_back: "Back",
                checkin_title: "Check-In", label_vent: "What's happening? (Vent here)", label_intensity: "Intensity (1-10)", level: "Level", label_reaction: "First Reaction?", btn_decode: "Decode My Pattern", btn_cancel: "Cancel",
                label_detected: "Core Wound Detected", label_what: "The Somatic Reality", label_why: "Origin Story", btn_interrupt: "Somatic Interrupter", btn_practice: "Micro-Practice", btn_anchor: "Truth Anchor", btn_journal_prompt: "Deep Inquiry", btn_save_result: "Save Result", btn_next_decode: "Start Next Decode",
                btn_save_vault: "Save to Vault", btn_analyze: "Analyze & Save", btn_vault: "The Vault", settings_title: "Settings", dark_mode: "Dark Mode", clear_data: "Clear Data",
                opt_indep: "Pulling away / Isolating", opt_cling: "Clinging / Panic texting", opt_shut: "Shutdown / Numb", opt_give: "Over-giving", opt_explain: "Over-explaining", opt_distrust: "Checking / Scanning", opt_blame: "Self-blame"
            },
            es: {
                welcome_title: "Bienvenido a Casa.", welcome_text: "Decodifica tus patrones de abandono.", btn_start: "Iniciar Chequeo (Gratis)", btn_journal: "Diario Guiado", btn_vault: "B√≥veda", btn_about: "Acerca de", link_course: "Tomar el Curso Completo",
                safety_title: "Seguridad Emocional", safety_text: "Herramienta de autoayuda, no terapia.", privacy_title: "Aviso de Privacidad", privacy_text: "Datos guardados solo en este dispositivo.", btn_agree: "Entiendo y Procedo", btn_back: "Atr√°s",
                checkin_title: "Chequeo", label_vent: "¬øQu√© est√° pasando? (Desah√≥gate aqu√≠)", label_intensity: "Intensidad (1-10)", level: "Nivel", label_reaction: "¬øPrimera Reacci√≥n?", btn_decode: "Decodificar Patr√≥n", btn_cancel: "Cancelar",
                label_detected: "Herida Central Detectada", label_what: "La Realidad Som√°tica", label_why: "Historia de Origen", btn_interrupt: "Interruptor Som√°tico", btn_practice: "Micro-Pr√°ctica", btn_anchor: "Ancla de Verdad", btn_journal_prompt: "Indagaci√≥n Profunda", btn_save_result: "Guardar Resultado", btn_next_decode: "Comenzar Nuevo",
                btn_save_vault: "Guardar en B√≥veda", btn_analyze: "Analizar y Guardar", btn_vault: "La B√≥veda", settings_title: "Configuraci√≥n", dark_mode: "Modo Oscuro", clear_data: "Borrar Datos",
                opt_indep: "Alejarse / Aislarse", opt_cling: "Aferrarse / P√°nico", opt_shut: "Apagado / Entumecido", opt_give: "Dar en exceso", opt_explain: "Explicar en exceso", opt_distrust: "Verificar / Escanear", opt_blame: "Culparse a s√≠ mismo"
            }
        };

        // --- DEEP WISDOM DATABASE (The "Therapist Brain") ---
        const LOGIC_DB = {
            'hyper_independence': {
                en: { name: "Protection Mode (Hyper-Independence)", what: "You aren't just 'pulling away'‚Äîyour nervous system has engaged a Protection Response. Vulnerability has been registered as a threat to your survival. You are creating distance not because you don't want connection, but because your body believes connection is unsafe.", why: "This is a survival strategy, not a personality flaw. You likely learned early on that you were the only one coming to save you. Your system imprinted 'aloneness' as the only reliable form of safety. To your inner child, needing others feels like walking into a trap.", interrupt: "Drop your shoulders significantly. Unclench your jaw. Exhale longer than you inhale. Say out loud: 'I am safe in this chair. I am safe in this room.'", practice: "The 5% Rule: Ask for help with one tiny, low-stakes thing today (e.g., 'Can you pass the salt?'). Prove to your nervous system that you can express a need and survive it.", anchor: "I do not have to carry it all to be worthy of love.", prompt: "What is the catastrophic story my mind is telling me about what will happen if I admit I need support right now?" },
                es: { name: "Modo Protecci√≥n (Hiperindependencia)", what: "No solo te est√°s 'alejando': tu sistema nervioso ha activado una Respuesta de Protecci√≥n. La vulnerabilidad ha sido registrada como una amenaza para tu supervivencia. Creas distancia no porque no quieras conexi√≥n, sino porque tu cuerpo cree que la conexi√≥n es insegura.", why: "Esta es una estrategia de supervivencia, no un defecto de personalidad. Probablemente aprendiste temprano que eras el √∫nico que vendr√≠a a salvarte. Tu sistema imprimi√≥ la 'soledad' como la √∫nica forma confiable de seguridad. Para tu ni√±o interior, necesitar a otros se siente como caer en una trampa.", interrupt: "Baja los hombros significativamente. Desaprieta la mand√≠bula. Exhala m√°s tiempo del que inhalas. Di en voz alta: 'Estoy seguro en esta silla'.", practice: "La Regla del 5%: Pide ayuda con una cosa peque√±a hoy. Demu√©strale a tu sistema nervioso que puedes expresar una necesidad y sobrevivir.", anchor: "No tengo que cargar todo para ser digno de amor.", prompt: "¬øCu√°l es la historia catastr√≥fica que mi mente me cuenta sobre lo que suceder√° si admito que necesito apoyo?" }
            },
            'panic_clinging': {
                en: { name: "Fight Mode (Anxious Grasping)", what: "You selected 'Clinging', but somatically, you are in a Sympathetic Fight Response. Your nervous system is screaming. This frantic urgency isn't 'neediness'‚Äîit is biological terror. Your body is mobilizing massive energy to bridge the gap because, to your primal brain, distance equals death.", why: "This is a primal attachment wound being touched. You likely learned that love was inconsistent or conditional. When the connection feels threatened, your body hijacks your brain to force a reconnection. You are trying to earn safety through proximity.", interrupt: "Put the phone down and walk into another room. Push your hands firmly against a wall for 10 seconds to discharge the fight energy. Splash cold water on your face to reset your vagus nerve.", practice: "Self-Soothing: Place a hand on your chest. Say: 'I am here with you. I am not leaving you.' Repeat until you feel your breath deepen. You must become the consistent caregiver you are seeking.", anchor: "My safety is inside me, not in their text message.", prompt: "What am I trying to get from them right now that I am starving for inside myself?" },
                es: { name: "Modo Lucha (Aferramiento Ansioso)", what: "Seleccionaste 'Aferrarse', pero som√°ticamente est√°s en una Respuesta de Lucha. Tu sistema nervioso est√° gritando. Esta urgencia fren√©tica no es 'necesidad', es terror biol√≥gico. Tu cuerpo est√° movilizando energ√≠a masiva para cerrar la brecha porque, para tu cerebro primitivo, la distancia equivale a la muerte.", why: "Esta es una herida de apego primitiva. Probablemente aprendiste que el amor era inconsistente. Cuando la conexi√≥n se siente amenazada, tu cuerpo secuestra tu cerebro para forzar una reconexi√≥n.", interrupt: "Baja el tel√©fono y ve a otra habitaci√≥n. Empuja tus manos firmemente contra una pared durante 10 segundos. √âchate agua fr√≠a en la cara.", practice: "Autotranquilizaci√≥n: Pon una mano en tu pecho. Di: 'Estoy aqu√≠ contigo. No te dejar√©'. Repite hasta que tu respiraci√≥n se profundice.", anchor: "Mi seguridad est√° dentro de m√≠, no en su mensaje de texto.", prompt: "¬øQu√© estoy tratando de obtener de ellos ahora mismo por lo que estoy hambriento dentro de m√≠?" }
            },
            'shutdown': {
                en: { name: "Freeze Mode (Emotional Shutdown)", what: "You feel numb, foggy, or checked out. This is a Dorsal Vagal Shutdown. Your system has pulled the emergency brake because the emotional intensity became too high to process. You aren't 'cold'; you are overwhelmed.", why: "This is the ultimate survival strategy. When you couldn't fight or flee in the past, you learned to disappear inside yourself to survive. Your body believes that feeling nothing is safer than feeling this pain.", interrupt: "We need to mobilize slowly. Shake your hands vigorously. Hum a low tone (Voo sound) to stimulate the vagus nerve. Wrap yourself in a heavy blanket.", practice: "Orientation: Look around the room. Name 3 red objects. Name 3 things you can touch. Signal to your brain that you are in the present, not the past.", anchor: "It is safe to be in my body. I am right here.", prompt: "What specific emotion was I feeling right before I went numb?" },
                es: { name: "Modo Congelaci√≥n (Apagado Emocional)", what: "Te sientes entumecido o brumoso. Este es un Apagado Vagal Dorsal. Tu sistema ha tirado del freno de emergencia porque la intensidad emocional se volvi√≥ demasiado alta. No eres 'fr√≠o'; est√°s abrumado.", why: "Esta es la estrategia de supervivencia definitiva. Cuando no pod√≠as luchar o huir en el pasado, aprendiste a desaparecer dentro de ti mismo. Tu cuerpo cree que no sentir nada es m√°s seguro que sentir este dolor.", interrupt: "Necesitamos movilizarnos lentamente. Sacude las manos vigorosamente. Tararea un tono bajo. Envu√©lvete en una manta pesada.", practice: "Orientaci√≥n: Mira alrededor. Nombra 3 objetos rojos. Nombra 3 cosas que puedas tocar. Se√±ala a tu cerebro que est√°s en el presente.", anchor: "Es seguro estar en mi cuerpo. Estoy justo aqu√≠.", prompt: "¬øQu√© emoci√≥n espec√≠fica estaba sintiendo justo antes de entumecerme?" }
            }
        };

        // --- APP CONTROLLER ---
        window.App = {
            state: {
                lang: 'en',
                premium: localStorage.getItem('lunaPremium') === 'true',
                consent: localStorage.getItem('lunaConsent') === 'true',
                vault: JSON.parse(localStorage.getItem('lunaVault') || '{"free":[],"premium":[]}'),
                inputs: {},
                currentResult: null,
                activeModule: null
            },

            navigateTo: function(id) {
                document.querySelectorAll('main > div, main > section').forEach(el => el.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                if(id === 'screen-vault') App.renderVault();
            },

            toggleLang: function() {
                App.state.lang = App.state.lang === 'en' ? 'es' : 'en';
                document.getElementById('lang-display').innerText = App.state.lang.toUpperCase();
                App.translateUI();
            },

            translateUI: function() {
                const t = LANG[App.state.lang];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if(t[key]) el.innerText = t[key];
                });
            },

            runDecoder: function() {
                const b = document.getElementById('in-behavior').value;
                if(!b) return alert("Please select a behavior.");
                
                App.state.inputs = {
                    behavior: b,
                    vent: document.getElementById('in-vent').value,
                    intensity: document.getElementById('in-intensity').value
                };
                
                document.getElementById('decode-btn-text').innerText = "Analyzing...";
                document.getElementById('decode-spinner').classList.remove('hidden');

                setTimeout(() => {
                    const db = LOGIC_DB[b] || LOGIC_DB['panic_clinging']; // Default fallback logic
                    const data = db[App.state.lang];
                    
                    App.state.currentResult = { ...data }; // Store the result
                    
                    document.getElementById('out-pattern').innerText = data.name;
                    document.getElementById('out-what').innerText = data.what;
                    document.getElementById('out-why').innerText = data.why;
                    
                    // Reset Button
                    document.getElementById('decode-btn-text').innerText = "Decode My Pattern";
                    document.getElementById('decode-spinner').classList.add('hidden');
                    
                    App.navigateTo('screen-result');
                }, 800);
            },

            showModule: function(type) {
                if(type === 'journal' && !App.state.premium) return UI.showPaywall();
                App.state.activeModule = type;
                
                const r = App.state.currentResult;
                let content = "";
                
                // MAP BUTTONS TO DEEP CONTENT
                if (type === "interrupt") content = r.interrupt;
                else if (type === "practice") content = r.practice;
                else if (type === "anchor") content = r.anchor;
                else if (type === "journal") content = r.prompt;
                
                // TITLE FORMATTING
                const titles = { interrupt: "Somatic Interrupter", practice: "Micro-Practice", anchor: "Truth Anchor", journal: "Deep Inquiry" };
                document.getElementById('mod-title').innerText = titles[type] || type.toUpperCase();
                
                // CONTENT INJECTION
                document.getElementById('mod-content').innerText = content;
                
                // INPUT RECYCLING
                const jArea = document.getElementById('journal-area');
                if (type === 'journal') {
                    jArea.classList.remove('hidden');
                    // Inject user's vent into the journal prompt for continuity
                    document.getElementById('journal-input-module').value = App.state.inputs.vent ? `[My Situation]: ${App.state.inputs.vent}\n\n[Reflection]: ` : "";
                } else { jArea.classList.add('hidden'); }
                
                App.navigateTo('screen-module');
            },

            saveFreeEntry: function() {
                if(!App.state.consent) return App.navigateTo('screen-safety');
                const entry = { id: Date.now(), date: new Date().toISOString(), inputs: { ...App.state.inputs }, result: App.state.currentResult };
                App.state.vault.free.unshift(entry);
                localStorage.setItem('lunaVault', JSON.stringify(App.state.vault));
                UI.toast(App.state.lang === 'en' ? "Saved" : "Guardado");
            },

            saveModuleEntry: function() {
                if(!App.state.premium) return UI.showPaywall();
                let content = document.getElementById('mod-content').innerText;
                if (App.state.activeModule === 'journal') content += "\n\n" + document.getElementById('journal-input-module').value;
                const entry = { id: Date.now(), date: new Date().toISOString(), text: content, type: App.state.activeModule };
                App.state.vault.premium.unshift(entry);
                localStorage.setItem('lunaVault', JSON.stringify(App.state.vault));
                UI.toast("Saved");
            },

            renderVault: function(tab = 'free') {
                const list = document.getElementById('vault-content');
                const data = App.state.vault[tab];
                if (!data || data.length === 0) { list.innerHTML = '<p class="text-center text-gray-400 mt-10">Empty / Vac√≠o</p>'; return; }
                list.innerHTML = data.map(e => `<div class="bg-white p-4 rounded-xl shadow border-l-4 border-sage-500 mb-3 relative dark:bg-gray-800"><div class="flex justify-between mb-1"><span class="font-bold text-gray-800 dark:text-white">${e.result ? e.result.name : 'Journal'}</span><span class="text-xs text-gray-400">${new Date(e.date).toLocaleDateString()}</span></div><p class="text-sm text-gray-600 italic dark:text-gray-300">"${(e.inputs ? e.inputs.vent : e.text).substring(0, 60)}..."</p></div>`).join('');
            },

            switchTab: function(tab) {
                document.getElementById('tab-free').className = tab === 'free' ? 'flex-1 py-2 text-xs font-bold rounded bg-sage-100 text-sage-700' : 'flex-1 py-2 text-xs font-bold rounded text-gray-400';
                document.getElementById('tab-premium').className = tab === 'premium' ? 'flex-1 py-2 text-xs font-bold rounded bg-sage-100 text-sage-700' : 'flex-1 py-2 text-xs font-bold rounded text-gray-400';
                App.renderVault(tab);
            },

            // UTILS
            grantConsent: function() { App.state.consent = true; localStorage.setItem('lunaConsent', 'true'); App.navigateTo('screen-intake'); },
            startPremiumJournal: function() { if(!App.state.premium) return UI.showPaywall(); App.navigateTo('screen-premium-journal'); },
            startVoice: function(id) {
                if (!('webkitSpeechRecognition' in window)) return UI.toast("Mic not supported");
                const recognition = new webkitSpeechRecognition();
                recognition.lang = App.state.lang === 'en' ? 'en-US' : 'es-ES';
                recognition.onstart = () => { UI.toast("Listening..."); };
                recognition.onresult = (event) => document.getElementById(id).value += " " + event.results[0][0].transcript;
                recognition.start();
            },
            checkCode: function() {
                if (document.getElementById('accessCode').value.toUpperCase() === 'LUNA2025') {
                    App.state.premium = true; localStorage.setItem('lunaPremium', 'true');
                    alert("Unlocked!"); UI.closePaywall(); 
                    document.getElementById('upgradeBtn').classList.add('hidden');
                } else { alert("Incorrect Code"); }
            },
            reset: function() { document.getElementById('in-vent').value = ""; App.navigateTo('screen-home'); },
            clearVault: function() { if(confirm("Delete?")) { localStorage.removeItem('lunaVault'); location.reload(); } }
        };

        const UI = {
            toast: function(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); },
            showPaywall: function() { document.getElementById('paywallModal').classList.remove('hidden'); },
            closePaywall: function() { document.getElementById('paywallModal').classList.add('hidden'); },
            toggleModal: function(id) { const m = document.getElementById(id); m.classList.contains('hidden') ? m.classList.remove('hidden') : m.classList.add('hidden'); }
        };

        // INIT
        if(App.state.premium) document.getElementById('upgradeBtn').classList.add('hidden');
        if(Array.isArray(App.state.vault)) { App.state.vault = { free: App.state.vault, premium: [] }; localStorage.setItem('lunaVault', JSON.stringify(App.state.vault)); }
        App.navigateTo('screen-home');
    </script>
</body>
</html>